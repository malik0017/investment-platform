<!-- backend/templates/admin_associate.html -->
{% extends "admin_base.html" %}

{% block title %}Admin Associates{% endblock %}
{% block extra_css %}
<style>
  .financial-card {
    border-left: 8px solid;
    transition: all 0.3s ease;
  }

  .positive {
    color: #28a745 !important;
  }

  .negative {
    color: #dc3545 !important;
  }

  .zero {
    color: #6c757d !important;
  }

  .company-card {
    cursor: pointer;
    transition: transform 0.2s;
  }

  .company-card:hover {
    transform: translateY(-2px);
  }

  .selected-company {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
  }

  .metric-checkbox {
    margin-right: 10px;
  }

  .chart-controls {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  }

  .company-badge {
    margin: 2px;
    cursor: pointer;
  }

  /* Dark mode support */
  [data-bs-theme="dark"] .chart-controls {
    background: #2d3748;
    color: #e9ecef;
  }

  [data-bs-theme="dark"] .company-selection-section,
  [data-bs-theme="dark"] .metric-categories {
    background: #2d3748 !important;
    border-color: #4a5568 !important;
    color: #e9ecef;
  }

  [data-bs-theme="dark"] .company-card-select {
    background: #374151 !important;
    border-color: #4b5563 !important;
    color: #e9ecef;
  }

  [data-bs-theme="dark"] .company-card-select.checked {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%) !important;
  }

  [data-bs-theme="dark"] .company-card-select:hover {
    border-color: #60a5fa !important;
  }

  /* Enhanced Company Selection Styles - Matching Metrics Design */
  .company-selection-section {
    background: #fff;
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .company-categories {
    border: 1px solid #e9ecef;
    border-radius: 5px;
    padding: 15px;
    background: #fafafa;
    margin-bottom: 15px;
  }

  [data-bs-theme="dark"] .company-categories {
    background: #374151 !important;
    border-color: #4b5563 !important;
  }

  .company-category {
    border-left: 4px solid;
    padding-left: 10px;
    margin-bottom: 1.5rem;
  }

  .company-category:nth-child(1) {
    border-left-color: #4e73df;
  }

  .company-category:nth-child(2) {
    border-left-color: #1cc88a;
  }

  .company-category:nth-child(3) {
    border-left-color: #f6c23e;
  }

  .company-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .company-checkbox {
    margin-right: 5px;
  }

  .form-check-inline {
    margin-right: 15px;
    margin-bottom: 8px;
  }

  .quick-selection .btn-group {
    flex-wrap: wrap;
  }

  .quick-selection .btn {
    margin: 2px;
    font-size: 0.8rem;
  }

  /* Enhanced chart container */
  .chart-container {
    position: relative;
    height: 400px;
    width: 100%;
  }

  /* Company card styles with visible checkboxes */
  .company-card-select {
    position: relative;
    border: 2px solid #e3e6f0;
    border-radius: 8px;
    padding: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fc;
    min-width: 90px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .company-card-select:hover {
    border-color: #4e73df;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(78, 115, 223, 0.15);
  }

  .company-card-select.checked {
    border-color: #4e73df;
    background: linear-gradient(135deg, #f8f9fc 0%, #e3e6f0 100%);
  }

  .company-checkbox {
    position: static;
    opacity: 1;
    margin: 0;
    width: 16px;
    height: 16px;
  }

  .company-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    margin: 0;
    flex: 1;
  }

  .company-info {
    flex: 1;
  }

  .company-name {
    display: block;
    font-weight: 600;
    color: #2e59d9;
    font-size: 14px;
  }

  .company-stats {
    display: block;
    font-size: 12px;
  }

  .selected-companies-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .company-chip {
    background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
  }

  .company-chip:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(78, 115, 223, 0.3);
  }

  .company-chip .remove-chip {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .company-chip .remove-chip:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Dynamic financial card colors */
  .financial-card-rsr {
    border-left-color: #4e73df;
  }

  .financial-card-rtcc {
    border-left-color: #1cc88a;
  }

  .financial-card-smc {
    border-left-color: #36b9cc;
  }

  .financial-card-ssem {
    border-left-color: #f6c23e;
  }

  .financial-card-razin {
    border-left-color: #e74a3b;
  }

  .financial-card-rafaya {
    border-left-color: #6f42c1;
  }

  .financial-card-ppc {
    border-left-color: #858796;
  }

  .financial-card-gchicken {
    border-left-color: #fd7e14;
  }

  .financial-card-bayan {
    border-left-color: #20c997;
  }

  .financial-card-abetong {
    border-left-color: #e83e8c;
  }

  .financial-card-foodaroma {
    border-left-color: #6610f2;
  }

  .financial-card-impulse {
    border-left-color: #6c757d;
  }

  .financial-card-marooj {
    border-left-color: #20c9a6;
  }
  .centered-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
}
/* Custom SweetAlert2 Styles */
.custom-swal-popup {
    border-radius: 12px !important;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
    border: 1px solid #e2e8f0 !important;
}

.custom-swal-title {
    font-size: 14px !important;
    line-height: 1.4 !important;
    margin: 0 !important;
}

.custom-swal-icon {
    width: 24px !important;
    height: 24px !important;
    margin-right: 12px !important;
}

.custom-swal-html {
    font-size: 14px !important;
    padding: 0 !important;
}

/* Dark mode support for notifications */
[data-bs-theme="dark"] .custom-swal-popup {
    background: #1f2937 !important;
    border-color: #374151 !important;
    color: #f9fafb !important;
}

[data-bs-theme="dark"] .custom-swal-title {
    color: #f9fafb !important;
}

/* Progress bar styling */
.swal2-timer-progress-bar {
    height: 3px !important;
    border-radius: 0 0 12px 12px !important;
}
</style>

{% endblock %}
{% block content %}
<div class="container mt-4" id="main-content">
  <!-- Header Section -->
  <div class="row align-items-center mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 id="currentCompanyHeader">RSR Financial Data</h4>
          <p class="text-muted mb-0" id="currentSelectionInfo">Showing RSR company data</p>
        </div>
        <div class="d-flex gap-2">
          <select id="companySelect" class="form-select" style="width: auto;">
            <option value="">Select Company</option>
            {% for company in available_companies %}
            <option value="{{ company }}" {% if company=='RSR' %}selected{% endif %}>{{ company }}</option>
            {% endfor %}
          </select>
          <select id="yearSelect" class="form-select" style="width: auto;">
            <option value="">All Years</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Dynamic Chart Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Financial Trends Analysis</h5>
            <button class="btn btn-sm btn-outline-primary" id="autoRotateBtn">
              <i class="bi bi-play-circle"></i> Auto Rotate
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- Chart Controls -->
          <div class="chart-controls">
            <div class="row">
              <div class="col-md-6">
                <div class="company-selection-section">
                  <div class="section-header d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                      <i class="bi bi-building me-2"></i>Select Companies
                    </h6>
                    <div class="company-counter">
                      <span class="badge bg-primary" id="selectedCompaniesCount">1</span>
                      <span class="text-muted small ms-1">selected</span>
                    </div>
                  </div>

                  <!-- Company Categories -->
                  <div class="company-categories">
                    <!-- Group 1: Core Companies -->
                    <div class="company-category mb-3">
                      <h6 class="text-primary mb-2">
                        <i class="bi bi-star me-1"></i>Core Companies
                      </h6>
                      <div class="company-group">
                        {% for company in ['RSR', 'RTCC', 'SMC', 'SSEM'] %}
                        {% if company in available_companies %}
                        <div class="company-card-select" data-company="{{ company }}">
                          <input class="form-check-input company-checkbox" type="checkbox" id="company-{{ company }}"
                            value="{{ company }}" {% if company=='RSR' %}checked{% endif %}>
                          <label class="company-label" for="company-{{ company }}">
                            <div class="company-info">
                              <span class="company-name">{{ company }}</span>
                              {% if companies_summary[company] %}
                              <small class="company-stats">
                                <span class="text-success">
                                  <i class="bi bi-arrow-up-short"></i>
                                  {{ "{:.1f}%".format(companies_summary[company].return_on_equity or 0) }}
                                </span>
                              </small>
                              {% endif %}
                            </div>
                          </label>
                        </div>
                        {% endif %}
                        {% endfor %}
                      </div>
                    </div>

                    <!-- Group 2: Investment Companies -->
                    <div class="company-category mb-3">
                      <h6 class="text-success mb-2">
                        <i class="bi bi-graph-up me-1"></i>Associates Companies
                      </h6>
                      <div class="company-group">
                        {% for company in ['Bayan','Abetong', 'Razin', 'Rafaya', 'PPC', 'G.Chicken'] %}
                        {% if company in available_companies %}
                        <div class="company-card-select" data-company="{{ company }}">
                          <input class="form-check-input company-checkbox" type="checkbox" id="company-{{ company }}"
                            value="{{ company }}">
                          <label class="company-label" for="company-{{ company }}">
                            <div class="company-info">
                              <span class="company-name">{{ company }}</span>
                              {% if companies_summary[company] %}
                              <small class="company-stats">
                                <span class="text-success">
                                  <i class="bi bi-arrow-up-short"></i>
                                  {{ "{:.1f}%".format(companies_summary[company].return_on_equity or 0) }}
                                </span>
                              </small>
                              {% endif %}
                            </div>
                          </label>
                        </div>
                        {% endif %}
                        {% endfor %}
                      </div>
                    </div>

                    <!-- Group 3: Other Companies -->
                    <div class="company-category mb-3">
                      <h6 class="text-warning mb-2">
                        <i class="bi bi-building me-1"></i>Subsidiaries Companies
                      </h6>
                      <div class="company-group">
                        {% for company in available_companies %}
                        {% if company not in ['RSR', 'RTCC', 'SMC', 'SSEM','Bayan','Abetong', 'Razin', 'Rafaya', 'PPC', 'G.Chicken'] %}
                        <div class="company-card-select" data-company="{{ company }}">
                          <input class="form-check-input company-checkbox" type="checkbox" id="company-{{ company }}"
                            value="{{ company }}">
                          <label class="company-label" for="company-{{ company }}">
                            <div class="company-info">
                              <span class="company-name">{{ company }}</span>
                              {% if companies_summary[company] %}
                              <small class="company-stats">
                                <span class="text-success">
                                  <i class="bi bi-arrow-up-short"></i>
                                  {{ "{:.1f}%".format(companies_summary[company].return_on_equity or 0) }}
                                </span>
                              </small>
                              {% endif %}
                            </div>
                          </label>
                        </div>
                        {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Quick Selection Buttons -->
                <div class="quick-selection mt-3">
                  <h6 class="mb-2">Quick Selection:</h6>
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" id="selectAllCompanies">
                      Select All
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="deselectAllCompanies">
                      Deselect All
                    </button>
                    <button type="button" class="btn btn-outline-success" id="selectCoreCompanies">
                      Core Companies
                    </button>
                    <button type="button" class="btn btn-outline-info" id="selectInvestmentCompanies">
                      Associates
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="selectotherCompanies">
                      Subsidiaries
                    </button>
                  </div>
                </div>

                <!-- Selected Companies Preview -->
                <div class="selected-companies-preview mt-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted fw-bold">Selected Companies Preview</small>
                    <small class="text-muted fw-bold" id="selectedPreviewCount">1 company</small>
                  </div>
                  <div class="selected-companies-chips" id="selectedCompaniesChips">
                    <!-- Chips will be dynamically added here -->
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h6>Select Metrics:</h6>
                <div class="metric-categories">
                  <!-- Balance Sheet Metrics -->
                  <div class="metric-category mb-3">
                    <h6 class="text-primary mb-2">
                      <i class="bi bi-bar-chart-line me-1"></i>Balance Sheet
                    </h6>
                    <div class="metric-group">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-non-current-assets"
                          value="Non-current assets">
                        <label class="form-check-label" for="metric-non-current-assets">
                          Non-current Assets
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-current-assets"
                          value="Current assets">
                        <label class="form-check-label" for="metric-current-assets">
                          Current Assets
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-total-equity"
                          value="Total equity">
                        <label class="form-check-label" for="metric-total-equity">
                          Total Equity
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox"
                          id="metric-non-current-liability" value="Non-current liability">
                        <label class="form-check-label" for="metric-non-current-liability">
                          Non-current Liability
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-current-liabilities"
                          value="Current liabilities">
                        <label class="form-check-label" for="metric-current-liabilities">
                          Current Liabilities
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-total-liabilities"
                          value="Total liabilities">
                        <label class="form-check-label" for="metric-total-liabilities">
                          Total Liabilities
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Income Statement Metrics -->
                  <div class="metric-category mb-3">
                    <h6 class="text-success mb-2">
                      <i class="bi bi-graph-up me-1"></i>Income Statement
                    </h6>
                    <div class="metric-group">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-revenue"
                          value="Revenue">
                        <label class="form-check-label" for="metric-revenue">
                          Revenue
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-cost-of-revenue"
                          value="Cost of revenue">
                        <label class="form-check-label" for="metric-cost-of-revenue">
                          Cost of Revenue
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-gross-profit"
                          value="Gross (loss) / profit" checked>
                        <label class="form-check-label" for="metric-gross-profit">
                          Gross Profit
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-operating-profit"
                          value="Operating Profit / loss">
                        <label class="form-check-label" for="metric-operating-profit">
                          Operating Profit
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-profit-loss"
                          value="Profit & loss">
                        <label class="form-check-label" for="metric-profit-loss">
                          Profit & Loss
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Financial Ratios -->
                  <div class="metric-category mb-3">
                    <h6 class="text-warning mb-2">
                      <i class="bi bi-percent me-1"></i>Financial Ratios
                    </h6>
                    <div class="metric-group">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-gp-margin"
                          value="GP Margin">
                        <label class="form-check-label" for="metric-gp-margin">
                          GP Margin
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-np-margin"
                          value="NP Margin">
                        <label class="form-check-label" for="metric-np-margin">
                          NP Margin
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-asset-turnover"
                          value="Asset Turnover">
                        <label class="form-check-label" for="metric-asset-turnover">
                          Asset Turnover
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-financial-leverage"
                          value="Financial leverage">
                        <label class="form-check-label" for="metric-financial-leverage">
                          Financial Leverage
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-roe"
                          value="Return On Equity" checked>
                        <label class="form-check-label" for="metric-roe">
                          ROE
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-current-ratio"
                          value="Current Ratio">
                        <label class="form-check-label" for="metric-current-ratio">
                          Current Ratio
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-debt-to-asset"
                          value="Debt to Asset Ratio">
                        <label class="form-check-label" for="metric-debt-to-asset">
                          Debt to Asset
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-debt-to-equity"
                          value="Debt to Equity Ratio">
                        <label class="form-check-label" for="metric-debt-to-equity">
                          Debt to Equity
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input metric-checkbox" type="checkbox" id="metric-rsr-profit"
                          value="RSR Profit %">
                        <label class="form-check-label" for="metric-rsr-profit">
                          RSR Profit %
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Quick Selection Buttons -->
                <div class="quick-selection mt-3">
                  <h6 class="mb-2">Quick Selection:</h6>
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" id="selectAllMetrics">
                      Select All
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="deselectAllMetrics">
                      Deselect All
                    </button>
                    <button type="button" class="btn btn-outline-success" id="selectBalanceSheet">
                      Balance Sheet
                    </button>
                    <button type="button" class="btn btn-outline-info" id="selectIncomeStatement">
                      Income Statement
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="selectRatios">
                      Ratios
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="row  mt-3 ">
              <div class="col-12 d-flex centered-controls">
                <div class="col-4 d-flex">
                <!-- <label for="yearsBack" class="form-label">Years to Show:</label> -->
                <select id="yearsBack" class="form-select m-xl-2">
                  <option value="3">Last 3 Years</option>
                  <option value="5">Last 5 Years</option>
                  <option value="10">Last 10 Years</option>
                  <option value="15" selected>Last 15 Years</option>
                  <option value="20">Last 20 Years</option>
                </select>
              </div>
              <div class="col-auto d-flex align-items-end">
                <button class="btn btn-primary me-2" id="updateChartBtn">
                  <i class="bi bi-graph-up"></i> Update Chart
                </button>
                <button class="btn btn-outline-secondary" id="resetChartBtn">
                  <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
              </div>
              </div>
              
            </div>
          </div>

          <!-- Chart Canvas -->
          <div class="mt-3">
            <canvas id="trendChart" height="500"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Companies Badges -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-wrap align-items-center">
        <span class="me-2"><strong>Selected Companies:</strong></span>
        <div id="selectedCompaniesBadges"></div>
      </div>
    </div>
  </div>

  <!-- Financial Data Display -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="financialTabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#balanceSheet">Balance Sheet</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#incomeStatement">Income Statement</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#ratios">Financial Ratios</a>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="balanceSheet">
              <div id="balanceSheetData">
                <p class="text-muted text-center">Loading RSR balance sheet data...</p>
              </div>
            </div>
            <div class="tab-pane fade" id="incomeStatement">
              <div id="incomeStatementData">
                <p class="text-muted text-center">Loading RSR income statement data...</p>
              </div>
            </div>
            <div class="tab-pane fade" id="ratios">
              <div id="ratiosData">
                <p class="text-muted text-center">Loading RSR financial ratios...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Companies Overview -->
  <div class="row mb-4">
    <div class="col-12">
      <h4>Companies Overview</h4>
      <div class="row">
        {% for company, summary in companies_summary.items() %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
          <div
            class="card company-card financial-card financial-card-{{ company|lower }} {% if company == 'RSR' %}selected-company{% endif %}"
            data-company="{{ company }}">
            <div class="card-body">
              <h5 class="card-title">{{ company }}</h5>
              <div class="row">
                <div class="col-6">
                  <small class="text-muted">Latest Year</small>
                  <p class="mb-1">{{ summary.latest_year or 'N/A' }}</p>
                </div>
                <div class="col-6">
                  <small class="text-muted">Total Assets</small>
                  <p class="mb-1">
                    {% if summary.total_assets %}
                    {{ "{:,.0f}".format(summary.total_assets) }}
                    {% else %}
                    N/A
                    {% endif %}
                  </p>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <small class="text-muted">Profit & loss</small>
                  <p
                    class="mb-0 {% if summary.net_profit and summary.net_profit > 0 %}positive{% elif summary.net_profit and summary.net_profit < 0 %}negative{% else %}zero{% endif %}">
                    {% if summary.net_profit is not none and summary.net_profit != 0 %}
                    {{ "{:,.0f}".format(summary.net_profit) }}
                    {% else %}
                    -
                    {% endif %}
                  </p>
                </div>
                <div class="col-6">
                  <small class="text-muted">ROE</small>
                  <p
                    class="mb-0 {% if summary.return_on_equity and summary.return_on_equity > 0 %}positive{% elif summary.return_on_equity and summary.return_on_equity < 0 %}negative{% else %}zero{% endif %}">
                    {% if summary.return_on_equity and summary.return_on_equity != 0 %}
                    {{ "{:.2f}%".format(summary.return_on_equity) }}
                    {% else %}
                    -
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
<script
  src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>

<script>
  // Global variables
  let trendChart = null;
  let autoRotateInterval = null;
  let currentMetrics = ['Gross (loss) / profit', 'Return On Equity'];
  let currentCompanies = ['RSR'];
  let chartLoading = false;

  // Enhanced color palette with unique colors for each company
  const companyColors = {
    'RSR': '#4e73df',
    'RTCC': '#1cc88a',
    'SMC': '#36b9cc',
    'SSEM': '#f6c23e',
    'Razin': '#e74a3b',
    'Rafaya': '#6f42c1',
    'PPC': '#858796',
    'G.Chicken': '#fd7e14',
    'Bayan': '#20c997',
    'Abetong': '#e83e8c',
    'Food Aroma': '#6610f2',
    'Impulse': '#6c757d',
    'Marooj': '#20c9a6'
  };

  // Metric categories
  const metricCategories = {
    balanceSheet: [
      'Non-current assets', 'Current assets', 'Total equity',
      'Non-current liability', 'Current liabilities', 'Total liabilities'
    ],
    incomeStatement: [
      'Revenue', 'Cost of revenue', 'Gross (loss) / profit',
      'Operating Profit / loss', 'Profit & loss'
    ],
    ratios: [
      'GP Margin', 'NP Margin', 'Asset Turnover', 'Financial leverage',
      'Return On Equity', 'Current Ratio', 'Debt to Asset Ratio',
      'Debt to Equity Ratio', 'RSR Profit %'
    ]
  };

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM Content Loaded - Initializing page...');
    initializePage();
  });

  function initializePage() {
    console.log('Initializing page...');

    // Set RSR as default selection
    document.getElementById('companySelect').value = 'RSR';

    // Load initial data immediately
    loadYears('RSR');
    loadFinancialData();

    // Set up event listeners first
    setupEventListeners();
    setupCompanySelection();
    setupQuickSelectionButtons();
    setupCompanyQuickSelection();

    // Then update UI
    updateCompanySelectionUI();
    updateSelectedCompaniesBadges();

    // Load initial chart after a short delay to ensure everything is set up
    setTimeout(() => {
      loadTrendChart();
    }, 500);
  }

  // Enhanced company selection setup
  function setupCompanySelection() {
    console.log('Setting up company selection...');

    // Company card click handler
    document.querySelectorAll('.company-card-select').forEach(card => {
      const checkbox = card.querySelector('.company-checkbox');
      const company = card.dataset.company;

      // Set initial color
      updateCompanyCardColor(card, company, checkbox.checked);

      card.addEventListener('click', function (e) {
        console.log('Company card clicked:', company);
        if (e.target !== checkbox && !e.target.closest('.remove-chip')) {
          checkbox.checked = !checkbox.checked;
          console.log('Checkbox toggled to:', checkbox.checked);
          handleCompanySelectionChange();
        }
      });

      checkbox.addEventListener('change', function () {
        console.log('Checkbox changed:', company, this.checked);
        handleCompanySelectionChange();
      });
    });
  }

  function handleCompanySelectionChange() {
    console.log('Handling company selection change...');

    // Update current companies from checkboxes
    updateSelectedCompanies();

    // Update all UI components
    updateCompanySelectionUI();
    updateSelectedCompaniesBadges();

    // Update the dropdown to reflect multiple selections
    if (currentCompanies.length === 1) {
      document.getElementById('companySelect').value = currentCompanies[0];
    } else {
      document.getElementById('companySelect').value = '';
    }

    // Update financial data for single company view
    if (currentCompanies.length === 1) {
      const company = currentCompanies[0];
      console.log('Single company selected, loading data for:', company);
      loadYears(company);
      loadFinancialData();
    } else {
      // Clear financial data when multiple companies selected
      console.log('Multiple companies selected, clearing financial data');
      clearFinancialData();
    }

    // Always update the chart
    console.log('Updating chart with companies:', currentCompanies);
    loadTrendChart();
  }

  function updateCompanyCardColor(card, company, isChecked) {
    const color = companyColors[company] || '#6c757d';

    if (isChecked) {
      card.style.borderColor = color;
    } else {
      card.style.borderColor = '#e3e6f0';
    }
  }

  function updateCompanySelectionUI() {
    console.log('Updating company selection UI...');
    const companyCards = document.querySelectorAll('.company-card-select');

    companyCards.forEach(card => {
      const checkbox = card.querySelector('.company-checkbox');
      const company = card.dataset.company;

      if (checkbox.checked) {
        card.classList.add('checked');
      } else {
        card.classList.remove('checked');
      }

      updateCompanyCardColor(card, company, checkbox.checked);
    });

    updateSelectedCompaniesChips();
    updateSelectedCompaniesCount();
  }

  function updateSelectedCompanies() {
    const selectedCheckboxes = Array.from(document.querySelectorAll('.company-checkbox:checked'));
    currentCompanies = selectedCheckboxes.map(checkbox => checkbox.value);

    console.log('Updated current companies:', currentCompanies);

    // Update header based on selection
    updateHeaderForMultipleCompanies();
  }

  function updateHeaderForMultipleCompanies() {
    const header = document.getElementById('currentCompanyHeader');
    const info = document.getElementById('currentSelectionInfo');

    if (currentCompanies.length === 1) {
      header.textContent = `${currentCompanies[0]} Financial Analysis`;
      info.textContent = `Analyzing ${currentCompanies[0]} financial performance`;
    } else if (currentCompanies.length > 1) {
      header.textContent = `${currentCompanies.length} Companies Comparison`;
      info.textContent = `Comparing ${currentCompanies.join(', ')}`;
    } else {
      header.textContent = 'Financial Analysis';
      info.textContent = 'Please select at least one company';
    }
  }

  function updateSelectedCompaniesChips() {
    const container = document.getElementById('selectedCompaniesChips');
    container.innerHTML = '';

    console.log('Updating chips for companies:', currentCompanies);

    currentCompanies.forEach(company => {
      const color = companyColors[company] || '#6c757d';
      const chip = document.createElement('div');
      chip.className = 'company-chip';
      chip.style.background = `linear-gradient(135deg, ${color} 0%, ${darkenColor(color, 20)} 100%)`;

      chip.innerHTML = `
        ${company}
        <button class="remove-chip" data-company="${company}">
          <i class="bi bi-x"></i>
        </button>
      `;

      chip.querySelector('.remove-chip').addEventListener('click', function (e) {
        e.stopPropagation();
        const companyToRemove = this.dataset.company;
        console.log('Removing company from chips:', companyToRemove);
        const checkbox = document.querySelector(`#company-${companyToRemove}`);
        if (checkbox) {
          checkbox.checked = false;
          handleCompanySelectionChange();
        }
      });

      container.appendChild(chip);
    });
  }

  function updateSelectedCompaniesCount() {
    const countElement = document.getElementById('selectedCompaniesCount');
    const previewCountElement = document.getElementById('selectedPreviewCount');

    if (countElement) {
      countElement.textContent = currentCompanies.length;
      // Update badge color based on count
      if (currentCompanies.length === 0) {
        countElement.className = 'badge bg-danger';
      } else if (currentCompanies.length === 1) {
        countElement.className = 'badge bg-primary';
      } else {
        countElement.className = 'badge bg-success';
      }
    }

    if (previewCountElement) {
      previewCountElement.textContent = `${currentCompanies.length} ${currentCompanies.length === 1 ? 'company' : 'companies'}`;
    }
  }

  function updateSelectedCompaniesBadges() {
    const container = document.getElementById('selectedCompaniesBadges');
    container.innerHTML = '';

    console.log('Updating badges for companies:', currentCompanies);

    currentCompanies.forEach(company => {
      const color = companyColors[company] || '#6c757d';
      const badge = document.createElement('span');
      badge.className = 'badge company-badge me-2 mb-2';
      badge.style.backgroundColor = color;
      badge.style.border = `2px solid ${color}`;
      badge.style.cursor = 'pointer';
      badge.innerHTML = `
        ${company} 
        <i class="bi bi-x-circle ms-1" style="font-size: 12px;"></i>
      `;

      badge.addEventListener('click', function (e) {
        console.log('Badge clicked for removal:', company);
        const checkbox = document.querySelector(`#company-${company}`);
        if (checkbox) {
          checkbox.checked = false;
          handleCompanySelectionChange();
        }
      });

      container.appendChild(badge);
    });
  }

  // Utility function to darken colors
  function darkenColor(color, percent) {
    const num = parseInt(color.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.max((num >> 16) - amt, 0);
    const G = Math.max((num >> 8 & 0x00FF) - amt, 0);
    const B = Math.max((num & 0x0000FF) - amt, 0);
    return "#" + (
      0x1000000 +
      (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
      (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
      (B < 255 ? B < 1 ? 0 : B : 255)
    ).toString(16).slice(1);
  }

  function setupCompanyQuickSelection() {
    // Select All Companies
    document.getElementById('selectAllCompanies').addEventListener('click', function () {
      document.querySelectorAll('.company-checkbox').forEach(checkbox => {
        checkbox.checked = true;
      });
      handleCompanySelectionChange();
    });

    // Deselect All Companies
    document.getElementById('deselectAllCompanies').addEventListener('click', function () {
      document.querySelectorAll('.company-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      handleCompanySelectionChange();
    });

    // Select Core Companies
    document.getElementById('selectCoreCompanies').addEventListener('click', function () {
      document.querySelectorAll('.company-checkbox').forEach(checkbox => {
        checkbox.checked = ['RSR', 'RTCC', 'SMC', 'SSEM'].includes(checkbox.value);
      });
      handleCompanySelectionChange();
    });

    // Select Investment Companies
    document.getElementById('selectInvestmentCompanies').addEventListener('click', function () {
      document.querySelectorAll('.company-checkbox').forEach(checkbox => {
        checkbox.checked = ['Bayan', 'Abetong', 'Razin', 'Rafaya', 'PPC', 'G.Chicken'].includes(checkbox.value);
      });
      handleCompanySelectionChange();
    });

    // Select other Companies
    document.getElementById('selectotherCompanies').addEventListener('click', function () {
      document.querySelectorAll('.company-checkbox').forEach(checkbox => {
        checkbox.checked = ['Food Aroma', 'Impulse', 'Marooj'].includes(checkbox.value);
      });
      handleCompanySelectionChange();
    });
  }

  function setupQuickSelectionButtons() {
    // Select All Metrics
    document.getElementById('selectAllMetrics').addEventListener('click', function () {
      document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
        checkbox.checked = true;
      });
      updateSelectedMetrics();
      loadTrendChart();
    });

    // Deselect All Metrics
    document.getElementById('deselectAllMetrics').addEventListener('click', function () {
      document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      updateSelectedMetrics();
      loadTrendChart();
    });

    // Select Balance Sheet Metrics
    document.getElementById('selectBalanceSheet').addEventListener('click', function () {
      document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
        checkbox.checked = metricCategories.balanceSheet.includes(checkbox.value);
      });
      updateSelectedMetrics();
      loadTrendChart();
    });

    // Select Income Statement Metrics
    document.getElementById('selectIncomeStatement').addEventListener('click', function () {
      document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
        checkbox.checked = metricCategories.incomeStatement.includes(checkbox.value);
      });
      updateSelectedMetrics();
      loadTrendChart();
    });

    // Select Ratios
    document.getElementById('selectRatios').addEventListener('click', function () {
      document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
        checkbox.checked = metricCategories.ratios.includes(checkbox.value);
      });
      updateSelectedMetrics();
      loadTrendChart();
    });
  }

  function setupEventListeners() {
    const companySelect = document.getElementById('companySelect');
    const yearSelect = document.getElementById('yearSelect');
    const updateChartBtn = document.getElementById('updateChartBtn');
    const resetChartBtn = document.getElementById('resetChartBtn');
    const autoRotateBtn = document.getElementById('autoRotateBtn');

    companySelect.addEventListener('change', function () {
      const company = this.value;
      console.log('Company dropdown changed to:', company);
      if (company) {
        // Update checkbox selection - select only this company
        document.querySelectorAll('.company-checkbox').forEach(checkbox => {
          checkbox.checked = checkbox.value === company;
        });
        handleCompanySelectionChange();
      } else {
        // If empty selection, deselect all
        document.querySelectorAll('.company-checkbox').forEach(checkbox => {
          checkbox.checked = false;
        });
        handleCompanySelectionChange();
      }
    });

    yearSelect.addEventListener('change', function () {
      if (currentCompanies.length === 1) {
        loadFinancialData();
      }
    });

    // Company card click handler for overview cards
    document.querySelectorAll('.company-card').forEach(card => {
      card.addEventListener('click', function () {
        const company = this.dataset.company;
        console.log('Overview card clicked:', company);

        // Update checkbox selection - select only this company
        document.querySelectorAll('.company-checkbox').forEach(checkbox => {
          checkbox.checked = checkbox.value === company;
        });
        handleCompanySelectionChange();

        // Update visual selection
        document.querySelectorAll('.company-card').forEach(c => {
          c.classList.remove('selected-company');
        });
        this.classList.add('selected-company');
      });
    });

    // Metric checkbox handler
    document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function () {
        updateSelectedMetrics();
        loadTrendChart();
      });
    });

    updateChartBtn.addEventListener('click', function () {
      loadTrendChart();
    });

    resetChartBtn.addEventListener('click', function () {
      resetChartSelections();
    });

    autoRotateBtn.addEventListener('click', function () {
      toggleAutoRotate();
    });
  }

  function updateSelectedMetrics() {
    currentMetrics = Array.from(document.querySelectorAll('.metric-checkbox:checked'))
      .map(checkbox => checkbox.value);
    console.log('Updated metrics:', currentMetrics);
  }

  function loadYears(company) {
    fetch(`/api/associates/${company}/years`)
      .then(response => response.json())
      .then(years => {
        const yearSelect = document.getElementById('yearSelect');
        yearSelect.innerHTML = '<option value="">All Years</option>';
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
      })
      .catch(error => console.error('Error loading years:', error));
  }

  function loadFinancialData() {
    const company = document.getElementById('companySelect').value;
    const year = document.getElementById('yearSelect').value;

    if (!company) return;

    // Load balance sheet
    loadTabData('balance_sheet', 'balanceSheetData', company, year);

    // Load income statement
    loadTabData('income_statement', 'incomeStatementData', company, year);

    // Load ratios
    loadTabData('ratios', 'ratiosData', company, year);
  }

  function clearFinancialData() {
    document.getElementById('balanceSheetData').innerHTML = '<p class="text-muted text-center">Select a single company to view detailed financial data</p>';
    document.getElementById('incomeStatementData').innerHTML = '<p class="text-muted text-center">Select a single company to view detailed financial data</p>';
    document.getElementById('ratiosData').innerHTML = '<p class="text-muted text-center">Select a single company to view detailed financial data</p>';
  }

  function loadTabData(dataType, containerId, company, year) {
    let url = `/api/associates/${company}/financial-data?type=${dataType}`;
    if (year) {
      url += `&year=${year}`;
    }

    fetch(url)
      .then(response => response.json())
      .then(data => {
        displayFinancialData(data, containerId, dataType);
      })
      .catch(error => console.error(`Error loading ${dataType}:`, error));
  }

  function displayFinancialData(data, containerId, dataType) {
    const container = document.getElementById(containerId);

    if (!data || Object.keys(data).length === 0) {
      container.innerHTML = '<p class="text-muted text-center">No data available</p>';
      return;
    }

    // Get all unique years from the data
    const years = new Set();
    Object.values(data).forEach(item => {
      if (item && typeof item === 'object') {
        Object.keys(item).forEach(year => years.add(year));
      }
    });
    const sortedYears = Array.from(years).sort((a, b) => b - a);

    let html = `
        <div class="table-responsive">
            <table class="table table-striped table-hover financial-table">
                <thead class="table-dark">
                    <tr>
                        <th>Account Item</th>
                        ${sortedYears.map(year => `<th class="text-end">${year}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
    `;

    // Define comprehensive ordering for different data types
    const predefinedOrders = {
      balance_sheet: [
        'Non-current assets',
        'Current assets',
        'Total assets',
        'Total equity',
        'Non-current liability',
        'Current liabilities',
        'Total liabilities',
        'Total equity and liabilities'
      ],
      income_statement: [
        'Revenue',
        'Cost of revenue',
        'Gross (loss) / profit',
        'Operating Profit / loss',
        'Profit Before Zakat',
        'Net Profit For The Year',
        'Profit & loss'
      ],
      ratios: [
        'GP Margin',
        'NP Margin',
        'Asset Turnover',
        'Financial leverage',
        'Return On Equity',
        'Current Ratio',
        'Debt to Asset Ratio',
        'Debt to Equity Ratio',
        'RSR Profit %'
      ]
    };

    // Get items in proper order
    let orderedItems = [];
    if (predefinedOrders[dataType]) {
      orderedItems = predefinedOrders[dataType].filter(item => data.hasOwnProperty(item));
      const remainingItems = Object.keys(data)
        .filter(item => !predefinedOrders[dataType].includes(item))
        .sort();
      orderedItems = [...orderedItems, ...remainingItems];
    } else {
      orderedItems = Object.keys(data).sort();
    }

    orderedItems.forEach(item => {
      const yearData = data[item];
      if (!yearData) return;

      // Add special styling for total/summary rows
      const isTotalRow = item.toLowerCase().includes('total') ||
        item.toLowerCase().includes('equity and liabilities');
      const rowClass = isTotalRow ? 'table-active' : '';

      html += `<tr class="${rowClass}"><td><strong>${item}</strong></td>`;

      sortedYears.forEach(year => {
        const value = yearData[year] || 0;
        const formattedValue = formatFinancialValue(value, dataType, item);
        const valueClass = getValueClass(value, dataType);
        html += `<td class="text-end ${valueClass}">${formattedValue}</td>`;
      });

      html += `</tr>`;
    });

    html += `</tbody></table></div>`;
    container.innerHTML = html;
  }

  function getValueClass(value, dataType) {
    if (value === 0 || value === '0' || value === null || value === undefined) {
      return 'zero';
    }

    const numValue = parseFloat(value);
    if (isNaN(numValue)) return '';

    if (dataType === 'ratios') {
      return numValue >= 0 ? 'positive' : 'negative';
    }

    // For balance sheet and income statement
    return numValue >= 0 ? 'positive' : 'negative';
  }

  function formatFinancialValue(value, dataType, item) {
    // Handle zero values
    if (value === 0 || value === '0' || value === null || value === undefined) {
      return '-';
    }

    const numValue = parseFloat(value);
    if (isNaN(numValue)) return '-';

    // Apply *100 and % formatting only for GP Margin and NP Margin
    if (item === 'GP Margin' || item === 'NP Margin') {
      return `${(numValue * 100).toFixed(1)}%`;
    }

    // For other ratio items, just add % without *100
    if (dataType === 'ratios') {
      return `${numValue.toFixed(2)}%`;
    } else {
      const absValue = Math.abs(numValue);
      if (absValue >= 1000000) {
        return `${(numValue / 1000000).toFixed(2)}M`;
      } else if (absValue >= 1000) {
        return `${(numValue / 1000).toFixed(1)}K`;
      } else {
        return `${numValue.toFixed(0)}`;
      }
    }
  }

  function loadTrendChart() {
    // Prevent multiple simultaneous chart loads
    if (chartLoading) {
      console.log('Chart load already in progress, skipping...');
      return;
    }

    const yearsBack = document.getElementById('yearsBack').value;

    if (currentCompanies.length === 0 || currentMetrics.length === 0) {
      showNotification('Please select at least one company and one metric', 'warning');
      return;
    }

    chartLoading = true;
    showLoading('Loading chart data...');

    const params = new URLSearchParams({
      years_back: yearsBack
    });

    currentCompanies.forEach(company => params.append('companies[]', company));
    currentMetrics.forEach(metric => params.append('metrics[]', metric));

    console.log('Loading chart with params:', params.toString());

    fetch(`/api/associates/trend-data?${params}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        hideLoading();
        chartLoading = false;
        renderTrendChart(data);
      })
      .catch(error => {
        console.error('Error loading trend data:', error);
        hideLoading();
        chartLoading = false;
        showNotification('Error loading chart data: ' + error.message, 'error');
      });
  }

  function renderTrendChart(data) {
    const ctx = document.getElementById('trendChart').getContext('2d');

    // Destroy existing chart
    if (trendChart) {
      trendChart.destroy();
    }

    // Check if we have valid data
    if (!data || !data.datasets || data.datasets.length === 0) {
      console.warn('No chart data available');
      showNotification('No chart data available for the selected criteria', 'warning');
      return;
    }

    // Enhanced chart configuration
    trendChart = new Chart(ctx, {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          title: {
            display: true,
            text: currentCompanies.length > 1 ?
              `${currentCompanies.length} Companies Comparison` :
              `${currentCompanies[0]} Financial Trends`,
            font: {
              size: 18,
              weight: 'bold'
            },
            color: '#2e59d9'
          },
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#2e59d9',
            borderWidth: 1,
            cornerRadius: 4,
            usePointStyle: true,
            callbacks: {
              label: function (context) {
                let label = context.dataset.label || '';
                const value = context.parsed.y;
                const isRatio = context.dataset.label?.includes('Margin') ||
                  context.dataset.label?.includes('Ratio') ||
                  context.dataset.label?.includes('ROE');

                if (isRatio) {
                  return `${label}: ${value.toFixed(2)}%`;
                } else {
                  if (Math.abs(value) >= 1000000) {
                    return `${label}: ${(value / 1000000).toFixed(2)}M`;
                  } else if (Math.abs(value) >= 1000) {
                    return `${label}: ${(value / 1000).toFixed(1)}K`;
                  } else {
                    return `${label}: ${value.toFixed(0)}`;
                  }
                }
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            },
            title: {
              display: true,
              text: 'Financial Year',
              color: '#6c757d',
              font: {
                size: 12,
                weight: 'bold'
              }
            }
          },
          y: {
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            },
            title: {
              display: true,
              text: 'Value',
              color: '#6c757d',
              font: {
                size: 12,
                weight: 'bold'
              }
            },
            ticks: {
              callback: function (value) {
                if (Math.abs(value) >= 1000000) {
                  return (value / 1000000).toFixed(1) + 'M';
                } else if (Math.abs(value) >= 1000) {
                  return (value / 1000).toFixed(0) + 'K';
                }
                return value;
              }
            }
          }
        },
        elements: {
          point: {
            radius: 4,
            hoverRadius: 6,
            borderWidth: 2
          },
          line: {
            tension: 0.4,
            borderWidth: 2
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });
  }

  function resetChartSelections() {
    console.log('Resetting chart selections...');

    // Reset to default selections
    document.querySelectorAll('.company-checkbox').forEach(checkbox => {
      checkbox.checked = checkbox.value === 'RSR';
    });

    document.querySelectorAll('.metric-checkbox').forEach(checkbox => {
      checkbox.checked = ['Gross (loss) / profit', 'Return On Equity'].includes(checkbox.value);
    });

    updateSelectedCompanies();
    updateSelectedMetrics();
    updateCompanySelectionUI();

    // Reset dropdown
    document.getElementById('companySelect').value = 'RSR';

    loadTrendChart();

    showNotification('Chart selections reset to defaults', 'info');
  }

  function toggleAutoRotate() {
    const btn = document.getElementById('autoRotateBtn');

    if (autoRotateInterval) {
      // Stop auto rotation
      clearInterval(autoRotateInterval);
      autoRotateInterval = null;
      btn.innerHTML = '<i class="bi bi-play-circle"></i> Auto Rotate';
      btn.classList.remove('btn-danger');
      btn.classList.add('btn-outline-primary');
      showNotification('Auto rotation stopped', 'info');
    } else {
      // Start auto rotation
      btn.innerHTML = '<i class="bi bi-pause-circle"></i> Stop Rotation';
      btn.classList.remove('btn-outline-primary');
      btn.classList.add('btn-danger');

      let currentIndex = 0;
      const allCompanies = Array.from(document.querySelectorAll('.company-checkbox'))
        .map(cb => cb.value);

      showNotification('Auto rotation started - cycling through companies every 3 seconds', 'success');

      autoRotateInterval = setInterval(() => {
        // Rotate through companies
        currentIndex = (currentIndex + 1) % allCompanies.length;
        const nextCompany = allCompanies[currentIndex];

        // Update checkbox selection - select only this company
        document.querySelectorAll('.company-checkbox').forEach(checkbox => {
          checkbox.checked = checkbox.value === nextCompany;
        });
        handleCompanySelectionChange();

      }, 3000); // Rotate every 3 seconds
    }
  }

  // Beautiful notification system using SweetAlert2
  function showNotification(message, type = 'info') {
    console.log(`${type.toUpperCase()}: ${message}`);

    // Map notification types to SweetAlert2 icons and colors
    const notificationConfig = {
      'info': {
        icon: 'info',
        iconColor: '#3b82f6',
        background: '#ffffff',
        titleColor: '#1e293b',
        textColor: '#64748b'
      },
      'success': {
        icon: 'success',
        iconColor: '#10b981',
        background: '#ffffff',
        titleColor: '#1e293b',
        textColor: '#64748b'
      },
      'warning': {
        icon: 'warning',
        iconColor: '#f59e0b',
        background: '#ffffff',
        titleColor: '#1e293b',
        textColor: '#64748b'
      },
      'error': {
        icon: 'error',
        iconColor: '#ef4444',
        background: '#ffffff',
        titleColor: '#1e293b',
        textColor: '#64748b'
      }
    };

    const config = notificationConfig[type] || notificationConfig.info;

    // Create beautiful toast notification
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 4000,
      timerProgressBar: true,
      width: '380px',
      padding: '1rem',
      background: config.background,
      backdrop: false,
      animation: true,
      customClass: {
        container: 'animate__animated animate__fadeInRight',
        popup: 'custom-swal-popup shadow-lg border-0',
        title: 'custom-swal-title fw-semibold',
        htmlContainer: 'custom-swal-html',
        icon: 'custom-swal-icon'
      },
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer);
        toast.addEventListener('mouseleave', Swal.resumeTimer);
      }
    });

    Toast.fire({
      icon: config.icon,
      title: message,
      iconColor: config.iconColor,
      color: config.textColor,
      showClass: {
        popup: 'animate__animated animate__fadeInRight animate__faster'
      },
      hideClass: {
        popup: 'animate__animated animate__fadeOutRight animate__faster'
      }
    });
  }

  function showLoading(message) {
    console.log(`Loading: ${message}`);
    const chartContainer = document.getElementById('trendChart').parentElement;
    let loadingOverlay = chartContainer.querySelector('.loading-overlay');

    if (!loadingOverlay) {
      loadingOverlay = document.createElement('div');
      loadingOverlay.className = 'loading-overlay';
      loadingOverlay.innerHTML = `
        <div class="text-center">
          <div class="loading-spinner mb-2"></div>
          <div>${message}</div>
        </div>
      `;
      chartContainer.style.position = 'relative';
      chartContainer.appendChild(loadingOverlay);
    }
  }

  function hideLoading() {
    console.log('Loading complete');
    const chartContainer = document.getElementById('trendChart').parentElement;
    const loadingOverlay = chartContainer.querySelector('.loading-overlay');
    if (loadingOverlay) {
      loadingOverlay.remove();
    }
  }
</script>
{% endblock %}
<!-- backend/templates/projects/admin_project_detail.html -->
{% extends "admin_base.html" %}

{% block title %}{{ project.title }} - Project Details{% endblock %}
{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .timeline-marker {
        position: absolute;
        left: -2rem;
        top: 0.5rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #007bff;
    }

    .timeline-content {
        padding-left: 1rem;
        border-left: 2px solid #e9ecef;
        padding-bottom: 1rem;
    }

    .timeline-item:last-child .timeline-content {
        border-left: 2px solid transparent;
    }
</style>
{% endblock %}
{% block content %}
<div class="container mt-4">
    <!-- Project Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ project.title }}</h2>
            <p class="text-muted mb-0">{{ project.description }}</p>
        </div>
        <div>
            <a href="{{ url_for('admin_projects') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Projects
            </a>
            <a href="{{ url_for('admin_project_edit', project_id=project.id) }}" class="btn btn-primary ms-2">
                <i class="bi bi-pencil"></i> Edit Project
            </a>
        </div>
    </div>

    <!-- Project Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="projectTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                type="button" role="tab">
                Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button"
                role="tab">
                Tasks
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="team-tab" data-bs-toggle="tab" data-bs-target="#team" type="button" role="tab">
                Team
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="milestones-tab" data-bs-toggle="tab" data-bs-target="#milestones" type="button"
                role="tab">
                Milestones
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button"
                role="tab">
                Documents
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button"
                role="tab">
                Activity
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="projectTabsContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <!-- Project Status Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Category</h6>
                            <h4>{{ project.category.name }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Status</h6>
                            <h4>
                                <span
                                    class="badge bg-{% if project.status == 'Completed' %}success{% elif project.status == 'Active' %}primary{% elif project.status == 'On Hold' %}warning{% elif project.status == 'Cancelled' %}danger{% else %}secondary{% endif %}">
                                    {{ project.status }}
                                </span>
                            </h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Budget</h6>
                            <h4>{{ project.budget | format_currency if project.budget else 'Not set' }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Progress</h6>
                            <h4>{{ project.progress }}%</h4>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: {{ project.progress }}%">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Details -->
            <div class="row">
                <div class="col-md-8">
                    <!-- Timeline/Milestones -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Project Timeline</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Start Date:</strong> {{ project.start_date | format_date if
                                        project.start_date
                                        else 'Not set' }}</p>
                                    <p><strong>End Date:</strong> {{ project.end_date | format_date if project.end_date
                                        else
                                        'Not set' }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Priority:</strong> {{ project.priority }}</p>
                                    <p><strong>Created:</strong> {{ project.created_at | format_date }}</p>
                                </div>
                            </div>
                            <p><strong>Company:</strong> {{ project.title }}</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('admin_project_task_create', project_id=project.id) }}"
                                    class="btn btn-outline-primary">
                                    <i class="bi bi-plus-circle"></i> Add Task
                                </a>
                                <a href="{{ url_for('admin_project_edit', project_id=project.id) }}"
                                    class="btn btn-outline-secondary">
                                    <i class="bi bi-pencil"></i> Edit Project
                                </a>
                                <a href="{{ url_for('admin_projects') }}" class="btn btn-outline-dark">
                                    <i class="bi bi-list-ul"></i> View All Projects
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div class="tab-pane fade" id="tasks" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Project Tasks</h4>
                <a href="{{ url_for('admin_project_task_create', project_id=project.id) }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Task
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="list-group">
                        {% for task in project.tasks %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ task.title }}</h6>
                                    {% if task.description %}
                                    <small class="text-muted">{{ task.description }}</small>
                                    {% endif %}
                                </div>
                                <div class="btn-group ms-3">
                                    <a href="{{ url_for('admin_project_task_edit', project_id=project.id, task_id=task.id) }}"
                                        class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <form method="POST"
                                        action="{{ url_for('admin_project_task_delete', project_id=project.id, task_id=task.id) }}"
                                        onsubmit="return confirm('Are you sure you want to delete this task?');"
                                        style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: {{ task.progress }}%"></div>
                            </div>

                            <div class="mt-2">
                                <small class="text-muted">
                                    Status: <span
                                        class="badge bg-{% if task.status == 'Completed' %}success{% elif task.status == 'In Progress' %}primary{% elif task.status == 'On Hold' %}warning{% elif task.status == 'Cancelled' %}danger{% else %}secondary{% endif %}">
                                        {{ task.status }}
                                    </span>
                                    | Priority: <span
                                        class="badge bg-{% if task.priority == 'High' %}danger{% elif task.priority == 'Critical' %}dark{% elif task.priority == 'Low' %}secondary{% else %}info{% endif %}">
                                        {{ task.priority }}
                                    </span>
                                    {% if task.assigned_to %} | Assigned to: {{ task.assigned_user.username if
                                    task.assigned_user else 'Unknown' }}{% endif %}
                                    {% if task.due_date %} | Due: {{ task.due_date.strftime('%Y-%m-%d') }}{% endif %}
                                    {% if task.estimated_hours %} | Est: {{ task.estimated_hours }}h{% endif %}
                                </small>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <p class="text-muted mt-3">No tasks yet</p>
                            <a href="{{ url_for('admin_project_task_create', project_id=project.id) }}"
                                class="btn btn-primary btn-sm">
                                Create First Task
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Tab -->
        <div class="tab-pane fade" id="team" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Project Team</h4>
                <a href="{{ url_for('admin_project_team', project_id=project.id) }}" class="btn btn-primary">
                    <i class="bi bi-people"></i> Manage Team
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    {% for member in project.team_members %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar avatar-sm me-3">
                            <span class="avatar-title bg-primary rounded-circle">
                                {{ member.member.username[0] | upper }}
                            </span>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0">{{ member.member.username }}</h6>
                            <small class="text-muted">{{ member.role }}</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-people display-4 text-muted"></i>
                        <p class="text-muted mt-2">No team members assigned</p>
                        <a href="{{ url_for('admin_project_team', project_id=project.id) }}"
                            class="btn btn-primary btn-sm">
                            Add Team Members
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Milestones Tab -->
        <div class="tab-pane fade" id="milestones" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Project Milestones</h4>
                <a href="{{ url_for('admin_project_milestones', project_id=project.id) }}" class="btn btn-primary">
                    <i class="bi bi-flag"></i> Manage Milestones
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    {% if project.milestones %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Completed Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for milestone in project.milestones|sort(attribute='due_date') %}
                                <tr>
                                    <td>
                                        <strong>{{ milestone.title }}</strong>
                                        {% if milestone.description %}
                                        <br><small class="text-muted">{{ milestone.description|truncate(50) }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ milestone.due_date.strftime('%Y-%m-%d') if milestone.due_date else 'Not set'
                                        }}</td>
                                    <td>
                                        <span
                                            class="badge bg-{% if milestone.status == 'Achieved' %}success{% elif milestone.status == 'Delayed' %}danger{% else %}warning{% endif %}">
                                            {{ milestone.status }}
                                        </span>
                                    </td>
                                    <td>{{ milestone.completed_date.strftime('%Y-%m-%d') if milestone.completed_date
                                        else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="text-muted">
                            <i class="bi bi-flag" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No milestones found</h5>
                            <p>Add milestones to track your project progress</p>
                            <a href="{{ url_for('admin_project_milestones', project_id=project.id) }}"
                                class="btn btn-primary">
                                Add Milestones
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Documents Tab -->
        <div class="tab-pane fade" id="documents" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Project Documents</h4>
                <a href="{{ url_for('admin_project_documents', project_id=project.id) }}" class="btn btn-primary">
                    <i class="bi bi-file-earmark"></i> Manage Documents
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    {% if project.documents %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>File Type</th>
                                    <th>Uploaded By</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for document in project.documents|sort(attribute='uploaded_at', reverse=true) %}
                                <tr>
                                    <td>{{ document.title }}</td>
                                    <td>{{ document.description|truncate(30) if document.description else 'No
                                        description' }}</td>
                                    <td>{{ document.file_type|upper }}</td>
                                    <td>{{ document.uploader.username if document.uploader else 'Unknown' }}</td>
                                    <td>{{ document.uploaded_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="text-muted">
                            <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No documents found</h5>
                            <p>Upload documents to keep all project files organized</p>
                            <a href="{{ url_for('admin_project_documents', project_id=project.id) }}"
                                class="btn btn-primary">
                                Upload Documents
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Activity Tab -->
        <div class="tab-pane fade" id="activity" role="tabpanel">
            <h4>Recent Activity</h4>

            <div class="card">
                <div class="card-body">
                    {% if project.activities %}
                    <div class="timeline">
                        {% for activity in project.activities|sort(attribute='created_at', reverse=true) %}
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">{{ activity.description }}</h6>
                                    <small class="text-muted">{{ activity.created_at.strftime('%Y-%m-%d %H:%M')
                                        }}</small>
                                </div>
                                <small class="text-muted">
                                    By {{ activity.user.username if activity.user else 'System' }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="text-muted">
                            <i class="bi bi-clock-history" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No activity yet</h5>
                            <p>Activities will appear here as you work on the project</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}
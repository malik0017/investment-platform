{% extends "admin_base.html" %}

{% block title %}
Financial Performance - Investment Admin
{% endblock %}

{% block extra_css %}
<style>
    .profit-positive {
        color: #28a745;
    }

    .profit-negative {
        color: #dc3545;
    }

    .filter-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .date-filter-container {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .date-filter-btn {
        background: linear-gradient(45deg, #4e73df, #224abe);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .date-filter-btn:hover {
        background: linear-gradient(45deg, #224abe, #4e73df);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .chart-container {
        position: relative;
        height: 60px;
        width: 100%;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
        padding: 15px 0;
    }

    .date-range-card {
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .date-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .date-filter-container {
            width: 100%;
        }

        .date-input-group {
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }

        .date-input-separator {
            display: none;
        }
    }
    /* Riskometer Styles for GP and MP */
    .riskometer {
        --riskometer-width: 240px;
        --riskometer-height: calc(var(--riskometer-width) / 2);
        align-items: flex-end;
        background: radial-gradient(
                at 50% var(--riskometer-height),
                transparent 50%,
                hsla(0, 0%, 100%, 0)
            ),
            conic-gradient(
                from 270deg at bottom,
                #08a046 0 30deg,
                #00cc1b 30deg 60deg,
                #fe0 60deg 90deg,
                #ffae07 90deg 120deg,
                #fc7a1e 120deg 150deg,
                #c80036 150deg 180deg
            );
        background-blend-mode: color-dodge;
        border-radius: var(--riskometer-height) var(--riskometer-height) 0 0;
        display: flex;
        height: var(--riskometer-height);
        justify-content: center;
        margin: 0 auto 30px;
        position: relative;
        width: var(--riskometer-width);
    }
    .riskometer:before {
        --inner-circle-width-offset: calc(var(--riskometer-height) * 20 / 100);
        --inner-circle-width: calc(
            var(--riskometer-height) + var(--inner-circle-width-offset)
        );
        --inner-circle-height: calc(var(--inner-circle-width) / 2);
        background: #fff;
        border-radius: var(--inner-circle-width) var(--inner-circle-width) 0 0;
        bottom: 0;
        content: "";
        display: block;
        height: var(--inner-circle-height);
        position: absolute;
        width: var(--inner-circle-width);
        z-index: 1;
    }
    .riskometer .indicator {
        --indicator-width-offset: calc(var(--riskometer-height) * 10 / 100);
        --indicator-width: calc(
            var(--riskometer-height) - var(--indicator-width-offset)
        );
        --indicator-height: calc(var(--indicator-width) / 2);
        height: var(--indicator-height);
        position: absolute;
        width: var(--indicator-width);
        z-index: 1;
    }
    .riskometer .indicator:after {
        background-color: var(--adminuiux-theme-accent-1);
        border: 2px solid var(--adminuiux-theme-1);
        border-radius: 50%;
        content: "";
        height: 20px;
        left: 50%;
        margin-left: -10px;
        position: absolute;
        top: calc(100% - 10px);
        width: 20px;
        z-index: 1;
    }
    .riskometer .indicator:before {
        content: "";
        --arrow-width: calc(var(--riskometer-height) * 0.06);
        --arrow-height: calc(var(--riskometer-height) * 0.5);
        --arrow-width-double: calc(var(--arrow-width) * 2);
        border: var(--arrow-width) solid transparent;
        border-right: var(--arrow-height) solid var(--adminuiux-theme-1);
        bottom: calc(var(--riskometer-height) * -0.055);
        display: block;
        left: calc(var(--riskometer-height) * -0.115);
        position: absolute;
        rotate: var(--arrow-rotation);
        transform-origin: calc(var(--indicator-height) + var(--arrow-width-double))
            var(--arrow-width);
        transition: rotate 0.3s;
        width: calc(var(--riskometer-height) * 0.01);
        z-index: 0;
    }

    /* Dynamic risk levels for GP Margin */
    .gp-riskometer.excellent { --arrow-rotation: 15deg; }
    .gp-riskometer.good { --arrow-rotation: 45deg; }
    .gp-riskometer.moderate { --arrow-rotation: 75deg; }
    .gp-riskometer.poor { --arrow-rotation: 105deg; }
    .gp-riskometer.critical { --arrow-rotation: 135deg; }
    .gp-riskometer.extreme { --arrow-rotation: 165deg; }

    /* Dynamic risk levels for MP Margin */
    .mp-riskometer.excellent { --arrow-rotation: 15deg; }
    .mp-riskometer.good { --arrow-rotation: 45deg; }
    .mp-riskometer.moderate { --arrow-rotation: 75deg; }
    .mp-riskometer.poor { --arrow-rotation: 105deg; }
    .mp-riskometer.critical { --arrow-rotation: 135deg; }
    .mp-riskometer.extreme { --arrow-rotation: 165deg; }

    /* Status indicator */
    .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
    }

    .status-excellent { background-color: #08a046; }
    .status-good { background-color: #00cc1b; }
    .status-moderate { background-color: #fe0; }
    .status-poor { background-color: #ffae07; }
    .status-critical { background-color: #fc7a1e; }
    .status-extreme { background-color: #c80036; }

    .riskometer-value {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
        z-index: 2;
    }

    .riskometer-labels {
        position: absolute;
        width: 100%;
        top: -25px;
        text-align: center;
        font-size: 12px;
        color: #6c757d;
        font-weight: 600;
    }

    .gp-riskometer .riskometer-labels span:first-child { float: left; margin-left: 10px; }
    .gp-riskometer .riskometer-labels span:last-child { float: right; margin-right: 10px; }

    .mp-riskometer .riskometer-labels span:first-child { float: left; margin-left: 10px; }
    .mp-riskometer .riskometer-labels span:last-child { float: right; margin-right: 10px; }

/* Working Capital Pyramid Chart Styles */
.pyramid-chart-container {
    position: relative;
    height: 200px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.working-capital-status {
    font-size: 14px;
    font-weight: 600;
    padding: 8px 12px;
    border-radius: 6px;
    text-align: center;
}

.status-positive {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
}

.status-negative {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div>
            <nav aria-label="breadcrumb" class="mb-2">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">
                            <i class="bi bi-house-door me-1"></i> Dashboard
                        </a></li>
                    <li class="breadcrumb-item active" aria-current="page">Financial Performance</li>
                </ol>
            </nav>
            <h4 class="mb-0">Financial Performance Dashboard
                {% if ytd_only %}<span class="badge bg-warning ms-2">YTD</span>{% endif %}
            </h4>
        </div>

        <!-- Date Filter Card -->
        <div class="date-range-card">
            <form method="POST" class="date-filter-container">
                <div class="date-input-group">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        <input type="date" class="form-control" name="start_date" value="{{ start_date }}"
                            id="startDatePicker" title="Start Date">
                    </div>
                    <span class="date-input-separator">to</span>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        <input type="date" class="form-control" name="end_date" value="{{ end_date }}"
                            id="endDatePicker" title="End Date">
                    </div>
                </div>
                <button type="submit" class="date-filter-btn" name="action" value="apply">
                    <i class="bi bi-filter me-1"></i> Apply
                </button>
            </form>
        </div>
    </div>
</div>

<div class="container mt-4" id="main-content">
    <div class="row">
        <!-- Profit/Loss Card -->
        <div class="col-12 col-sm-6 col-xxl-3 mb-4">
            <div class="card adminuiux-card overflow-hidden">
                <div class="card-body {% if current_profit_loss >= 0 %}theme-green{% else %}theme-red{% endif %}">
                    <div class="avatar avatar-60 text-center rounded bg-theme-1 text-white mb-3">
                        <i
                            class="bi {% if current_profit_loss >= 0 %}bi-graph-up-arrow{% else %}bi-graph-down-arrow{% endif %} h4"></i>
                    </div>
                    <h2
                        class="fw-medium {% if current_profit_loss >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                        {{ ytd_profit_loss|format_currency }}
                    </h2>
                    <p class="text-secondary small">
                        {% if ytd_only %}YTD {% endif %}Profit/Loss
                    </p>
                </div>
                <div class="chart-container">
                    <canvas id="profitLossChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Expense Card -->
        <div class="col-12 col-sm-6 col-xxl-3 mb-4">
            <div class="card adminuiux-card overflow-hidden">
                <div class="card-body theme-red">
                    <div class="avatar avatar-60 text-center rounded bg-theme-1 text-white mb-3">
                        <i class="bi bi-graph-up h4"></i>
                    </div>
                    <h2 class="fw-medium profit-negative">
                        {{ ytd_expenses|format_currency }}
                    </h2>
                    <p class="text-secondary small">
                        {% if ytd_only %}YTD {% endif %}Total Expenses
                    </p>
                </div>
                <div class="summarychart height-60 w-100">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Assets Card -->
        <div class="col-12 col-sm-6 col-xxl-3 mb-4">
            <div class="card adminuiux-card overflow-hidden">
                <div class="card-body theme-blue">
                    <div class="row mb-3">
                        <div class="col">
                            <div class="avatar avatar-60 text-center rounded bg-theme-1 text-white">
                                <i class="bi bi-building h4"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-square btn-link" onclick="refreshAssetData()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <h2 class="fw-medium">
                        {% set asset_value = total_assets | abs %}
                        {% if asset_value >= 1000000000 %}
                        {{ "{:,.2f}".format(asset_value / 1000000000) }}B
                        {% elif asset_value >= 1000000 %}
                        {{ "{:,.2f}".format(asset_value / 1000000) }}M
                        {% elif asset_value >= 1000 %}
                        {{ "{:,.2f}".format(asset_value / 1000) }}K
                        {% else %}
                        {{ "{:,.2f}".format(asset_value) }}
                        {% endif %}
                    </h2>
                    <p class="text-secondary small">{% if ytd_only %}YTD {% endif %}Total Assets</p>
                </div>
                <div class="summarychart height-60 w-100">
                    <canvas id="assetChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Liabilities Card -->
        <div class="col-12 col-sm-6 col-xxl-3 mb-4">
            <div class="card adminuiux-card overflow-hidden">
                <div class="card-body theme-purple">
                    <div class="row mb-3">
                        <div class="col">
                            <div class="avatar avatar-60 text-center rounded bg-theme-1 text-white">
                                <i class="bi bi-graph-down h4"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-square btn-link" onclick="refreshLiabilityData()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <h2 class="fw-medium">
                        {% set liability_value = total_liabilities | abs %}
                        {% if liability_value >= 1000000000 %}
                        {{ "{:,.2f}".format(liability_value / 1000000000) }}B
                        {% elif liability_value >= 1000000 %}
                        {{ "{:,.2f}".format(liability_value / 1000000) }}M
                        {% elif liability_value >= 1000 %}
                        {{ "{:,.2f}".format(liability_value / 1000) }}K
                        {% else %}
                        {{ "{:,.2f}".format(liability_value) }}
                        {% endif %}
                    </h2>
                    <p class="text-secondary small">{% if ytd_only %}YTD {% endif %}Total Liabilities</p>
                </div>
                <div class="summarychart height-60 w-100">
                    <canvas id="liabilityChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-12 col-xl-8 mb-4">
            <div class="card adminuiux-card h-100">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6>Profit and Loss Statement Breakdown</h6>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshPLChart()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="w-100 height-500 ">
                        <canvas id="profitLossStatementChart"></canvas>
                    </div>
                </div>
            </div>
        </div>       
        <!-- GP Margin Riskometer -->
        <div class="col-12 col-lg-6 col-xl-4 mb-4">
            <div class="card adminuiux-card">
                <div class="card-header">
                    <h6>GP & NP Margin</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h5 id="gp-status">
                            <span class="status-indicator status-excellent"></span>
                            Excellent
                        </h5>
                        <p class="text-secondary small mb-0">Gross Profit Margin</p>
                    </div>
        
                    <div class="riskometer gp-riskometer excellent" id="gp-riskometer">
                        <div class="indicator"></div>
                        <div class="riskometer-value" id="gp-riskometer-value">{{ "%.1f"|format(gp_margin) }}%</div>
                    </div>
        
                    <div class="text-center mt-3">
                        <h4 class="fw-medium text-dark mb-1">
                            {{ "%.1f"|format(gp_margin) }}%
                            <span class="fs-14" id="gp-trend">
                                {% if gp_margin >= 20 %}
                                <span class="text-success"><i class="bi bi-arrow-up-short me-1"></i> Excellent</span>
                                {% elif gp_margin >= 10 %}
                                <span class="text-success"><i class="bi bi-arrow-up-short me-1"></i> Good</span>
                                {% elif gp_margin >= 5 %}
                                <span class="text-warning"><i class="bi bi-dash me-1"></i> Moderate</span>
                                {% elif gp_margin >= 0 %}
                                <span class="text-warning"><i class="bi bi-arrow-down-short me-1"></i> Poor</span>
                                {% else %}
                                <span class="text-danger"><i class="bi bi-arrow-down-short me-1"></i> Critical</span>
                                {% endif %}
                            </span>
                        </h4>
                        <div class="row text-secondary small mt-2">
                            <div class="col-6 d-flex justify-content-center text-center">
                                <p class="mb-1"><strong>Gross Profit:</strong></p>
                                <p class="mb-0">{{ gross_profit|format_currency }}</p>
                            </div>
                            <div class="col-6 d-flex justify-content-center text-center">
                                <p class="mb-1"><strong>Revenue:</strong></p>
                                <p class="mb-0">{{ revenue|format_currency }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h5 id="mp-status">
                            <span class="status-indicator status-moderate"></span>
                            Moderate
                        </h5>
                        <p class="text-secondary small mb-0">Net Profit Margin</p>
                    </div>
                
                    <div class="riskometer mp-riskometer moderate" id="mp-riskometer">
                        <div class="indicator"></div>
                        <div class="riskometer-value" id="mp-riskometer-value">{{ "%.1f"|format(mp_margin) }}%</div>
                    </div>
                
                    <div class="text-center mt-3">
                        <h4 class="fw-medium text-dark mb-1">
                            {{ "%.1f"|format(mp_margin) }}%
                            <span class="fs-14" id="mp-trend">
                                {% if mp_margin >= 15 %}
                                <span class="text-success"><i class="bi bi-arrow-up-short me-1"></i> Excellent</span>
                                {% elif mp_margin >= 10 %}
                                <span class="text-success"><i class="bi bi-arrow-up-short me-1"></i> Good</span>
                                {% elif mp_margin >= 5 %}
                                <span class="text-warning"><i class="bi bi-dash me-1"></i> Moderate</span>
                                {% elif mp_margin >= 0 %}
                                <span class="text-warning"><i class="bi bi-arrow-down-short me-1"></i> Poor</span>
                                {% else %}
                                <span class="text-danger"><i class="bi bi-arrow-down-short me-1"></i> Critical</span>
                                {% endif %}
                            </span>
                        </h4>
                        <div class="row text-secondary small mt-2">
                            <div class="col-6 d-flex justify-content-center text-center">
                                <p class="mb-1"><strong>Net Profit:</strong></p>
                                <p class="mb-0">{{ net_profit|format_currency }}</p>
                            </div>
                            <div class="col-6 d-flex justify-content-center text-center">
                                <p class="mb-1"><strong>Revenue:</strong></p>
                                <p class="mb-0">{{ revenue|format_currency }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    <!-- Replace the entire Working Capital Pyramid section with this code -->
    <!-- ADD WORKING CAPITAL CARD HERE -->
    <div class="col-12 col-lg-6 col-xl-4 mb-4">
        <div class="card adminuiux-card h-100">
            <div class="card-header">
                <h6>Working Capital</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <h4 class="fw-medium {% if current_working_capital >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ current_working_capital|format_currency }}
                    </h4>
                    <p class="text-secondary small">Working Capital</p>
                </div>
    
                <!-- Pyramid Chart for Working Capital -->
                <div class="pyramid-chart-container">
                    <canvas id="workingCapitalPyramidChart"></canvas>
                </div>
    
                <div class="row text-center mt-3">
                    <div class="col-12 col-sm-6 col-lg-6 mb-3">
                        <div class="card bg-success bg-opacity-10 border-success h-100">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-title text-success mb-1">Current Assets:</h6>
                                <p class="card-text fw-bold text-dark mb-0">
                                    {{ current_assets_total|format_currency }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-6 mb-3">
                        <div class="card bg-warning bg-opacity-10 border-warning">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-title text-warning mb-1">Current Liabilities</h6>
                                <p class="card-text fw-bold text-dark mb-0">
                                    {{ assets_liabilities_breakdown.short_term_liabilities|format_currency }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
   
    <!-- Assets & Liabilities Breakdown Chart -->
    <div class="col-12 col-lg-12 col-xl-8 mb-4">
        <div class="card adminuiux-card h-100">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h6>Assets & Liabilities</h6>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshAssetsLiabilitiesChart()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="w-100 height-asset">
                    <canvas id="assetsLiabilitiesChart"></canvas>
                </div>
    
                <!-- Summary Cards -->
                <div class="row mt-4">
                    <div class="col-12 col-sm-6 col-lg-3 mb-3">
                        <div class="card bg-success bg-opacity-10 border-success" style="height: 100px;">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-title text-success mb-1">Current Assets</h6>
                                <p class="card-text fw-bold text-dark mb-0">
                                    {{ assets_liabilities_breakdown.short_term_assets|format_currency }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3 mb-3">
                        <div class="card bg-warning bg-opacity-10 border-warning" style="height: 100px;">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-title text-warning mb-1">Current Liabilities</h6>
                                <p class="card-text fw-bold text-dark mb-0">
                                    {{ assets_liabilities_breakdown.short_term_liabilities|format_currency }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3 mb-3">
                        <div class="card bg-primary bg-opacity-10 border-primary" style="height: 100px;">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-title text-primary mb-1">Non-Current Assets</h6>
                                <p class="card-text fw-bold text-dark mb-0">
                                    {{ assets_liabilities_breakdown.long_term_assets|format_currency }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3 mb-3">
                        <div class="card bg-danger bg-opacity-10 border-danger" style="height: 100px;">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-title text-danger mb-1">Non-Current Liabilities</h6>
                                <p class="card-text fw-bold text-dark mb-0">
                                    {{ assets_liabilities_breakdown.long_term_liabilities|format_currency }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  function initializeAssetsLiabilitiesChart() {
        const ctx = document.getElementById('assetsLiabilitiesChart');
        if (!ctx) {
            console.error('Assets & Liabilities chart canvas not found');
            return;
        }

        try {
            // Check if chart already exists and destroy it
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            const breakdown = {{ assets_liabilities_breakdown | tojson | safe
        }};
    console.log('Assets/Liabilities breakdown:', breakdown);

    // Use simplified labels for X-axis
    const labels = ['Current Asset', 'Current Libility', '', 'Non-Current Asset', 'Non-Current Libility'];
    const fullLabels = [
        'Short-term Assets',
        'Short-term Liabilities',
        '',
        'Long-term Assets',
        'Long-term Liabilities'
    ];

    const data = [
        breakdown.short_term_assets || 0,
        breakdown.short_term_liabilities || 0,
        0, // Empty space for separation
        breakdown.long_term_assets || 0,
        breakdown.long_term_liabilities || 0
    ];

    const backgroundColors = [
        'rgba(40, 167, 69, 0.8)',    
        'rgba(255, 193, 7, 0.8)',    
        'rgba(255, 255, 255, 0)',    
        'rgba(0, 123, 255, 0.8)',   
        'rgba(220, 53, 69, 0.8)'     
    ];

    const borderColors = [
        'rgba(40, 167, 69, 1)',
        'rgba(255, 193, 7, 1)',
        'rgba(255, 255, 255, 0)',
        'rgba(0, 123, 255, 1)',
        'rgba(220, 53, 69, 1)'
    ];

    // Calculate dynamic Y-axis max value
    const maxDataValue = Math.max(...data.filter((val, idx) => idx !== 2)); // Exclude empty space
    const yAxisMax = calculateYAxisMax(maxDataValue);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels, // This sets the X-axis labels
            datasets: [{
                label: 'Amount (SAR)',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function (tooltipItems) {
                            const index = tooltipItems[0].dataIndex;
                            return fullLabels[index] || '';
                        },
                        label: function (context) {
                            if (context.dataIndex === 2) return null;
                            return formatCurrencyNoDecimals(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: ' '
                    },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 0, 
                        minRotation: 0,
                        callback: function (value, index) {
                            if (index === 2) return ''; 
                            return this.getLabelForValue(value); 
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (SAR)'
                    },
                    ticks: {
                        callback: function (value) {
                            return formatCurrencyNoDecimals(value);
                        },
                        // Set fixed intervals based on the max value
                        stepSize: calculateStepSize(maxDataValue),
                        max: yAxisMax
                    },
                    // Ensure small values are still visible
                    min: 0
                }
            },
            // Add space between the bars
            layout: {
                padding: {
                    left: 20,
                    right: 20,
                    top: 20,
                    bottom: 10 // Extra bottom padding for X-axis labels
                }
            },
            // Adjust bar spacing for better grouping
            barPercentage: 0.5,
            categoryPercentage: 0.7,
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });

    console.log('Assets & Liabilities chart initialized successfully');
    } catch (error) {
        console.error('Error initializing assets & liabilities chart:', error);
    }
}

    // Helper function to format currency without decimal places
    function formatCurrencyNoDecimals(value) {
        const absValue = Math.abs(value);
        if (absValue >= 1000000) {
            return (value / 1000000).toFixed(0) + 'M';
        } else if (absValue >= 1000) {
            return (value / 1000).toFixed(0) + 'K';
        } else {
            return value.toFixed(0);
        }
    }

    // Helper function to calculate Y-axis max value
    function calculateYAxisMax(maxValue) {
        if (maxValue === 0) return 1000; // Default for zero values

        // Calculate appropriate max value with some padding
        const magnitude = Math.pow(10, Math.floor(Math.log10(maxValue)));
        const normalized = maxValue / magnitude;

        if (normalized <= 1) return magnitude * 1.2;
        if (normalized <= 2) return magnitude * 2;
        if (normalized <= 5) return magnitude * 5;
        return magnitude * 10;
    }

    // Helper function to calculate step size for Y-axis
    function calculateStepSize(maxValue) {
        if (maxValue === 0) return 100;

        const magnitude = Math.pow(10, Math.floor(Math.log10(maxValue)));
        const normalized = maxValue / magnitude;

        if (maxValue < 1000) {
            return 100; // For values under 1,000, use 100 intervals
        } else if (maxValue < 10000) {
            return 1000; // For values under 10,000, use 1,000 intervals
        } else if (maxValue < 100000) {
            return 10000; // For values under 100,000, use 10,000 intervals
        } else if (maxValue < 1000000) {
            return 100000; // For values under 1,000,000, use 100,000 intervals
        } else if (maxValue < 10000000) {
            return 1000000; // For values under 10,000,000, use 1,000,000 intervals
        } else {
            return 10000000; // For larger values, use 10,000,000 intervals
        }
    }

    // Add refresh function
    function refreshAssetsLiabilitiesChart() {
        initializeAssetsLiabilitiesChart();
    }
    // Riskometer initialization for GP and MP
        function initializeRiskometers() {
            const gpMargin = {{ gp_margin }};
        const mpMargin = {{ mp_margin }};

        console.log('Initializing riskometers - GP:', gpMargin, 'MP:', mpMargin);

        // Update riskometers with proper values
        updateRiskometer('gp', gpMargin, 50); // GP max at 50%
        updateRiskometer('mp', mpMargin, 25); // MP max at 25%
}

        function updateRiskometer(type, margin, maxValue) {
            const riskometer = document.getElementById(`${type}-riskometer`);
            const valueDisplay = document.getElementById(`${type}-riskometer-value`);
            const status = document.getElementById(`${type}-status`);
            const trend = document.getElementById(`${type}-trend`);

            if (!riskometer) {
                console.error(`${type} riskometer element not found`);
                return;
            }

            // Handle negative values - for negative margins, we want to show them in the critical/poor zone
            const isNegative = margin < 0;
            const isExtremeValue = margin > maxValue;

            // For negative values, we'll map them to the left side of the gauge (0% to -100% scale)
            let percentage, arrowRotation;

            if (isNegative) {
                // Map negative values to the left side (0% to -100% becomes 15deg to -15deg)
                const negativePercentage = Math.min(Math.abs(margin) / 100, 1); // Cap at -100%
                percentage = -negativePercentage;
                arrowRotation = calculateArrowRotationForNegative(negativePercentage);
            } else {
                // Handle positive values normally
                const displayMargin = isExtremeValue ? maxValue : Math.min(margin, maxValue);
                percentage = displayMargin / maxValue;
                arrowRotation = calculateArrowRotationForPositive(percentage);
            }

            // Calculate risk level
            const riskLevel = getRiskLevel(type, margin, isExtremeValue);

            console.log(`${type} Riskometer Update:`, {
                margin,
                maxValue,
                percentage,
                riskLevel,
                arrowRotation,
                isNegative,
                isExtremeValue
            });

            // Update riskometer class for styling
            updateRiskometerClass(riskometer, riskLevel);

            // Update the CSS custom property for arrow rotation
            riskometer.style.setProperty('--arrow-rotation', arrowRotation + 'deg');

            // Update value display
            if (valueDisplay) {
                if (isExtremeValue) {
                    valueDisplay.textContent = 'MAX+';
                    valueDisplay.style.color = '#c80036';
                    valueDisplay.style.fontSize = '20px';
                } else {
                    valueDisplay.textContent = margin.toFixed(1) + '%';
                    valueDisplay.style.color = isNegative ? '#c80036' : '#2c3e50';
                    valueDisplay.style.fontSize = '24px';
                }
            }

            // Update status and trend
            updateRiskometerStatus(status, trend, riskLevel, margin, type, isNegative);
        }

        function getRiskLevel(type, margin, isExtreme) {
            if (isExtreme) return 'extreme';

            // Handle negative values first
            if (margin < 0) {
                if (margin <= -20) return 'extreme';
                if (margin <= -10) return 'critical';
                if (margin <= -5) return 'poor';
                return 'moderate'; // For very small negative values
            }

            // Positive values
            if (type === 'gp') {
                if (margin >= 20) return 'excellent';
                if (margin >= 10) return 'good';
                if (margin >= 5) return 'moderate';
                return 'poor';
            } else {
                if (margin >= 15) return 'excellent';
                if (margin >= 10) return 'good';
                if (margin >= 5) return 'moderate';
                return 'poor';
            }
        }

        function calculateArrowRotationForPositive(percentage) {
            // Map positive percentage to 180-degree scale (0% = 15deg, 100% = 165deg)
            const baseRotation = 15; // Starting point (poor/moderate)
            const maxRotation = 165; // Ending point (excellent/extreme)

            return baseRotation + (percentage * (maxRotation - baseRotation));
        }

        function calculateArrowRotationForNegative(percentage) {
            // Map negative percentage to left side scale (0% = 15deg, -100% = -15deg)
            const baseRotation = 15; // Center position
            const maxNegativeRotation = -15; // Maximum left rotation

            return baseRotation + (percentage * (maxNegativeRotation - baseRotation));
        }

        function updateRiskometerClass(riskometer, riskLevel) {
            // Remove all risk level classes
            const classes = ['excellent', 'good', 'moderate', 'poor', 'critical', 'extreme'];
            riskometer.classList.remove(...classes);

            // Add current risk level class
            riskometer.classList.add(riskLevel);
        }

        function updateRiskometerStatus(statusElement, trendElement, riskLevel, margin, type, isNegative) {
            if (!statusElement || !trendElement) return;

            const statusText = riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
            const statusIndicatorClass = `status-${riskLevel}`;

            // Update status indicator
            statusElement.innerHTML = `
        <span class="status-indicator ${statusIndicatorClass}"></span>
        ${statusText}
    `;

            // Update trend text based on whether value is negative or positive
            let trendText = '';
            let trendClass = '';
            let trendIcon = '';

            if (isNegative) {
                trendClass = 'text-danger';
                trendIcon = 'bi-arrow-down-short';

                if (margin <= -20) {
                    trendText = 'Extreme Loss';
                } else if (margin <= -10) {
                    trendText = 'Critical Loss';
                } else if (margin <= -5) {
                    trendText = 'Significant Loss';
                } else {
                    trendText = 'Minor Loss';
                }
            } else {
                if (type === 'gp') {
                    if (margin >= 20) {
                        trendText = 'Excellent';
                        trendClass = 'text-success';
                        trendIcon = 'bi-arrow-up-short';
                    } else if (margin >= 10) {
                        trendText = 'Good';
                        trendClass = 'text-success';
                        trendIcon = 'bi-arrow-up-short';
                    } else if (margin >= 5) {
                        trendText = 'Moderate';
                        trendClass = 'text-warning';
                        trendIcon = 'bi-dash';
                    } else {
                        trendText = 'Poor';
                        trendClass = 'text-warning';
                        trendIcon = 'bi-arrow-down-short';
                    }
                } else {
                    if (margin >= 15) {
                        trendText = 'Excellent';
                        trendClass = 'text-success';
                        trendIcon = 'bi-arrow-up-short';
                    } else if (margin >= 10) {
                        trendText = 'Good';
                        trendClass = 'text-success';
                        trendIcon = 'bi-arrow-up-short';
                    } else if (margin >= 5) {
                        trendText = 'Moderate';
                        trendClass = 'text-warning';
                        trendIcon = 'bi-dash';
                    } else {
                        trendText = 'Poor';
                        trendClass = 'text-warning';
                        trendIcon = 'bi-arrow-down-short';
                    }
                }
            }

            trendElement.innerHTML = `
        <span class="${trendClass}">
            <i class="bi ${trendIcon} me-1"></i>
            ${trendText}
        </span>
    `;
        }

        function initializeWorkingCapitalPyramidChart() {
                const ctx = document.getElementById('workingCapitalPyramidChart');
                if (!ctx) {
                    console.error('Working Capital Pyramid chart canvas not found');
                    return;
                }

                try {
                    // Check if chart already exists and destroy it
                    const existingChart = Chart.getChart(ctx);
                    if (existingChart) {
                        existingChart.destroy();
                    }

                    const currentAssets = {{ current_assets_total }};
                const currentLiabilities = {{ current_liabilities_total }};
            const workingCapital = {{ current_working_capital }};

            // Create pyramid data
            const pyramidData = {
                labels: ['Current Assets', 'Current Liabilities','Working Capital'],
                datasets: [{
                    data: [currentAssets, currentLiabilities, Math.abs(workingCapital)],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',    // Green for assets
                        workingCapital >= 0 ? 'rgba(255, 193, 7, 0.8)' : 'rgba(220, 53, 69, 0.8)', // Yellow/Red for working capital
                        'rgba(220, 53, 69, 0.8)'     // Red for liabilities
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        workingCapital >= 0 ? 'rgba(255, 193, 7, 1)' : 'rgba(220, 53, 69, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            new Chart(ctx, {
                type: 'bar',
                data: pyramidData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label || ''}: ${formatCurrency(context.parsed.x)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });

            console.log('Working Capital Pyramid chart initialized successfully');
    } catch (error) {
                console.error('Error initializing working capital pyramid chart:', error);
            }
}

    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, initializing charts...');

        // Initialize margin gauges first
        initializeRiskometers();

        // Initialize all charts
        initializeCharts();

        // Set today's date as default if no date is selected
        const datePicker = document.getElementById('datePicker');
        if (datePicker && !datePicker.value) {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            datePicker.value = formattedDate;
        }
    });

    // Declare chart variables
    let profitChart = null;
    let expenseChart = null;
    let liabilityChart = null;
    let assetChart = null;
    let profitLossStatementChart = null;
    // let profitLossWaterfallChart = null;

    function initializeCharts() {
        // Destroy existing charts first
        destroyCharts();

        // Initialize all charts
        initializeProfitChart();
        initializeExpenseChart();
        initializeLiabilityChart();
        initializeAssetChart();
        initializeProfitLossStatementChart();
        initializeWorkingCapitalPyramidChart(); 
        initializeAssetsLiabilitiesChart();
    }

    // Add refresh function
    function refreshPLChart() {
        initializeProfitLossStatementChart();
    }

    function destroyCharts() {
        const charts = [profitChart, expenseChart, liabilityChart, assetChart, profitLossStatementChart];
        const chartIds = ['profitLossChart', 'expenseChart', 'liabilityChart', 'assetChart', 'profitLossStatementChart', 'workingCapitalPyramidChart', 'assetsLiabilitiesChart'];

        charts.forEach((chart, index) => {
            if (chart) {
                chart.destroy();
                charts[index] = null;
            }

            // Also check if Chart.js has any registered chart for this canvas
            const canvas = document.getElementById(chartIds[index]);
            if (canvas) {
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
            }
        });
    }

    function initializeProfitChart() {
        const ctx = document.getElementById('profitLossChart');
        if (!ctx) {
            console.error('Profit/Loss chart canvas not found');
            return;
        }

        try {
            // Check if chart already exists and destroy it
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            const monthlyData = {{ monthly_data | tojson | safe
        }};
    console.log('Monthly profit data:', monthlyData);

    let labels = [];
    let data = [];

    if (monthlyData && monthlyData.length > 0) {
        labels = monthlyData.map(item => item.month.substring(0, 3));
        data = monthlyData.map(item => item.profit);
    } else {
        // Fallback data
        labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        data = [12000, 19000, 3000, 5000, 2000, 3000];
    }

    const isProfit = {{ current_profit_loss }} >= 0;
    const chartColor = isProfit ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)';
    const bgColor = isProfit ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';

    profitChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Profit/Loss Trend',
                data: data,
                borderColor: chartColor,
                backgroundColor: bgColor,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: chartColor,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: getChartOptions()
    });

    console.log('Profit chart initialized successfully');
        } catch (error) {
        console.error('Error initializing profit chart:', error);
    }
    }

    function initializeExpenseChart() {
        const expenseCtx = document.getElementById('expenseChart');
        if (!expenseCtx) {
            console.error('Expense chart canvas not found');
            return;
        }

        try {
            // Check if chart already exists and destroy it
            const existingChart = Chart.getChart(expenseCtx);
            if (existingChart) {
                existingChart.destroy();
            }

            const monthlyExpenseData = {{ monthly_expense_data | tojson | safe
        }};
    console.log('Monthly expense data from server:', monthlyExpenseData);

    let expenseLabels = [];
    let expenseValues = [];

    if (monthlyExpenseData && monthlyExpenseData.length > 0) {
        expenseLabels = monthlyExpenseData.map(item => item.month.substring(0, 3));
        expenseValues = monthlyExpenseData.map(item => item.expense);
    } else {
        // Fallback data
        expenseLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        expenseValues = [5000, 7500, 6000, 8000, 7000, 9000];
    }

    console.log('Expense chart data:', { labels: expenseLabels, data: expenseValues });

    expenseChart = new Chart(expenseCtx, {
        type: 'line',
        data: {
            labels: expenseLabels,
            datasets: [{
                label: 'Expense Trend',
                data: expenseValues,
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function (context) {
                            const value = context.parsed.y;
                            if (Math.abs(value) >= 1000000) {
                                return '' + (value / 1000000).toFixed(2) + 'M';
                            } else if (Math.abs(value) >= 1000) {
                                return '' + (value / 1000).toFixed(2) + 'K';
                            } else {
                                return '' + value.toFixed(2);
                            }
                        }
                    }
                }
            },
            scales: {
                y: { display: false, beginAtZero: true },
                x: { display: false }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            },
            elements: {
                line: { borderWidth: 2 }
            }
        }
    });
    console.log('Expense chart initialized successfully');
        } catch (error) {
        console.error('Error initializing expense chart:', error);
    }
    }

    function initializeLiabilityChart() {
        const liabilityCtx = document.getElementById('liabilityChart');
        if (!liabilityCtx) {
            console.error('Liability chart canvas not found');
            return;
        }

        try {
            // Check if chart already exists and destroy it
            const existingChart = Chart.getChart(liabilityCtx);
            if (existingChart) {
                existingChart.destroy();
            }

            const monthlyLiabilityData = {{ monthly_liability_data | tojson | safe
        }};
    console.log('Monthly liability data from server:', monthlyLiabilityData);

    let liabilityLabels = [];
    let liabilityValues = [];

    if (monthlyLiabilityData && monthlyLiabilityData.length > 0) {
        liabilityLabels = monthlyLiabilityData.map(item => item.month.substring(0, 3));
        liabilityValues = monthlyLiabilityData.map(item => item.liability);
    } else {
        // Fallback data
        liabilityLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        liabilityValues = [15000, 16000, 15500, 16500, 17000, 17500];
    }

    console.log('Liability chart data:', { labels: liabilityLabels, data: liabilityValues });

    liabilityChart = new Chart(liabilityCtx, {
        type: 'line',
        data: {
            labels: liabilityLabels,
            datasets: [{
                label: 'Liability Trend',
                data: liabilityValues,
                borderColor: 'rgba(111, 66, 193, 1)',
                backgroundColor: 'rgba(111, 66, 193, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgba(111, 66, 193, 1)',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function (context) {
                            const value = context.parsed.y;
                            if (Math.abs(value) >= 1000000000) {
                                return '' + (value / 1000000000).toFixed(2) + 'B';
                            } else if (Math.abs(value) >= 1000000) {
                                return '' + (value / 1000000).toFixed(2) + 'M';
                            } else if (Math.abs(value) >= 1000) {
                                return '' + (value / 1000).toFixed(2) + 'K';
                            } else {
                                return '' + value.toFixed(2);
                            }
                        }
                    }
                }
            },
            scales: {
                y: { display: false, beginAtZero: true },
                x: { display: false }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            },
            elements: {
                line: { borderWidth: 2 }
            }
        }
    });
    console.log('Liability chart initialized successfully');
        } catch (error) {
        console.error('Error initializing liability chart:', error);
    }
    }

    function initializeAssetChart() {
        const assetCtx = document.getElementById('assetChart');
        if (!assetCtx) {
            console.error('Asset chart canvas not found');
            return;
        }

        try {
            // Check if chart already exists and destroy it
            const existingChart = Chart.getChart(assetCtx);
            if (existingChart) {
                existingChart.destroy();
            }

            const monthlyAssetData = {{ monthly_asset_data | tojson | safe
        }};
    console.log('Monthly asset data from server:', monthlyAssetData);

    let assetLabels = [];
    let assetValues = [];

    if (monthlyAssetData && monthlyAssetData.length > 0) {
        assetLabels = monthlyAssetData.map(item => item.month.substring(0, 3));
        assetValues = monthlyAssetData.map(item => item.assets);
    } else {
        // Fallback data
        assetLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        assetValues = [500000, 550000, 600000, 650000, 700000, 750000];
    }

    console.log('Asset chart data:', { labels: assetLabels, data: assetValues });

    assetChart = new Chart(assetCtx, {
        type: 'line',
        data: {
            labels: assetLabels,
            datasets: [{
                label: 'Asset Trend',
                data: assetValues,
                borderColor: 'rgba(0, 123, 255, 1)',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgba(0, 123, 255, 1)',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function (context) {
                            const value = context.parsed.y;
                            if (Math.abs(value) >= 1000000000) {
                                return '' + (value / 1000000000).toFixed(2) + 'B';
                            } else if (Math.abs(value) >= 1000000) {
                                return '' + (value / 1000000).toFixed(2) + 'M';
                            } else if (Math.abs(value) >= 1000) {
                                return '' + (value / 1000).toFixed(2) + 'K';
                            } else {
                                return '' + value.toFixed(2);
                            }
                        }
                    }
                }
            },
            scales: {
                y: { display: false, beginAtZero: true },
                x: { display: false }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            },
            elements: {
                line: { borderWidth: 2 }
            }
        }
    });
    console.log('Asset chart initialized successfully');
        } catch (error) {
        console.error('Error initializing asset chart:', error);
    }
    }

    function getChartOptions() {
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function (context) {
                            const value = context.parsed.y;
                            return formatCurrency(value);
                        }
                    }
                }
            },
            scales: {
                y: { display: false, beginAtZero: true },
                x: { display: false }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            },
            elements: {
                line: { borderWidth: 2 }
            }
        };
    }

    function initializeProfitLossStatementChart() {
        const ctx = document.getElementById('profitLossStatementChart');
        if (!ctx) {
            console.error('Profit/Loss Statement chart canvas not found');
            return;
        }

        try {
            // Check if chart already exists and destroy it
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            // Get data from template variables
            const plData = {{ pl_data | tojson | safe
        }};
    console.log('P&L Data for chart:', plData);

    // If no data, show a message and return
    if (!plData || Object.keys(plData).length === 0) {
        console.warn('No P&L data available for chart');
        ctx.parentElement.innerHTML = '<div class="text-center p-4 text-muted">No P&L data available for the selected period</div>';
        return;
    }

    // Define the categories we want to display in order
    const categories = [
        'Revenue',
        'Cost of Revenue',
        'Gross Profit/Loss',
        'Total Expenses',
        'Net Operating Profit',
        'Finance Cost', 'Zakat/Tax ',
        'Other Incomes',
        'Results in Subsidiary',
        'Results in Associate',
        'Total Investment Income',
        'Unrealized Valuation from Investment at Fair Value',
        'Income from investment at FV realised Gain',
        'NET PROFIT/LOSS'
    ];

    // Define expense items array
    const expenseItems = [
        'Salaries & Related', 'GOSI', 'Medical Insurance', 'Office Rent',
        'Other Office Exp', 'Professional Fees', 'Business Travel',
        'Consultation', 'Depreciation'
    ];

    // Define which categories are expenses (should be negative)
    const expenseCategories = [
        'Cost of Revenue',
        'Salaries & Related', 'GOSI', 'Medical Insurance', 'Office Rent',
        'Other Office Exp', 'Professional Fees', 'Business Travel',
        'Consultation', 'Depreciation', 'Total Expenses',
        'Finance Cost', 'Zakat/Tax '
    ];

    // Define which categories are income (should be positive)
    const incomeCategories = [
        'Revenue',
        'Other Incomes',
        'Unrealized Valuation from Investment at Fair Value',
        'Income from investment at FV realised Gain',
        'Dividend from investment at fair value P/L',
        'Results in Subsidiary',
        'Results in Associate',
        'Dividend from Investment at cost',
        'Interest Income',
        'Income from investment at Octal',
        'Change in the fair value of equity investment at fair value through OCI',
        'Gain from disposal of associate',
        'Remeasurement of defined employee benefits obligations',
        'Total Investment Income'
    ];

    const investmentItems = [
        'Dividend from investment at fair value P/L',
        'Dividend from Investment at cost',
        'Income from investment at Octal',
        'Change in the fair value of equity investment at fair value through OCI',
        'Gain from disposal of associate'
    ];

    const otherIncomeItems = [
        'Remeasurement of defined employee benefits obligations',
        'Other Income'
    ];

    const otherItemsInvestment = [
        'Unrealized Valuation from Investment at Fair Value',
        'Income from investment at FV realised Gain',
        'Results in Subsidiary',
        'Results in Associate'
    ]

    // Prepare data for the chart
    const chartData = categories.map(category => {
        let value = 0;

        if (category === 'Gross Profit/Loss') {
            const revenue = Math.abs(plData['Revenue'] || 0);
            const costOfRevenue = plData['Cost of Revenue'] || 0;
            value = revenue - costOfRevenue;
        }
        else if (category === 'Total Expenses') {
            // Sum all expense items (already negative)
            value = expenseItems.reduce((sum, item) => sum + (plData[item] || 0), 0);
        }
        else if (category === 'Net Operating Profit') {
            const revenue = Math.abs(plData['Revenue'] || 0);
            const costOfRevenue = plData['Cost of Revenue'] || 0;
            const totalExpenses = expenseItems.reduce((sum, item) => sum + (plData[item] || 0), 0);

            // Net Operating Profit = Revenue - (Cost of Revenue + Total Expenses)
            value = revenue - costOfRevenue - totalExpenses;
            if (value < 0) {
                value = -value; // Convert to positive if it's negative (loss)
            }
        }
        else if (category === 'Other Incomes') {
            value = otherIncomeItems.reduce((sum, item) => sum + (plData[item] || 0), 0);
        }
        else if (category === 'Total Investment Income') {
            value = investmentItems.reduce((sum, item) => sum + (plData[item] || 0), 0);
        }
        else if (category === 'NET PROFIT/LOSS') {
            // Calculate net profit/loss using proper values from plData
            const revenue = Math.abs(plData['Revenue'] || 0);
            const costOfRevenue = plData['Cost of Revenue'] || 0;
            const totalExpenses = expenseItems.reduce((sum, item) => sum + (plData[item] || 0), 0);
            const totalInvestmentIncome = investmentItems.reduce((sum, item) => sum + (plData[item] || 0), 0);
            const TotalotherItemsInvestment = otherItemsInvestment.reduce((sum, item) => sum + (plData[item] || 0), 0);
            console.log("otherItemsInvestment", TotalotherItemsInvestment);
            const interestIncome = Math.abs(plData['Interest Income'] || 0);
            const financeCost = Math.abs(plData['Finance Cost'] || 0);
            const zakatTax = Math.abs(plData['Zakat/Tax '] || 0);
            const employeeBenefit = Math.abs(plData['Remeasurement of defined employee benefits obligations'] || 0);
            const otherIncome = Math.abs(plData['Other Income'] || 0);
            value = totalInvestmentIncome - otherIncome - interestIncome + financeCost + zakatTax + employeeBenefit - revenue + costOfRevenue + totalExpenses + TotalotherItemsInvestment;
            if (value < 0) {
                value = -value; // Convert to positive if it's negative (loss)
            }
        }
        else {
            value = plData[category] || 0;
        }

        // Convert expenses to negative values
        if (expenseCategories.includes(category)) {
            value = -Math.abs(value);
        }
        // Ensure income values are positive
        else if (incomeCategories.includes(category)) {
            value = Math.abs(value);
        }

        return value;
    });

    // Define colors for different categories
    const backgroundColors = categories.map(category => {
        // Revenue - Green
        if (category === 'Revenue') return 'rgba(40, 167, 69, 0.8)';

        // Costs and Expenses - Red
        if (category === 'Cost of Revenue') return 'rgba(220, 53, 69, 0.8)';
        if ([
            'Salaries & Related', 'GOSI', 'Medical Insurance', 'Office Rent',
            'Other Office Exp', 'Professional Fees', 'Business Travel',
            'Consultation', 'Depreciation', 'Total Expenses',
            'Finance Cost', 'Zakat/Tax'
        ].includes(category)) return 'rgba(220, 53, 69, 0.6)';

        // Profit items - Green shades
        if (['Gross Profit/Loss', 'Net Operating Profit'].includes(category)) {
            // Color based on whether it's profit (green) or loss (red)
            const index = categories.indexOf(category);
            return chartData[index] >= 0 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)';
        }

        // Income items - Blue
        if (category === 'Other Incomes') return 'rgba(23, 162, 184, 0.8)';
        if (category === 'Results in Subsidiary') return 'rgba(40, 167, 69, 0.6)' ;

        if (category === 'Results in Associate') return 'rgba(40, 167, 69, 0.6)';

        if (category === 'Unrealized Valuation from Investment at Fair Value') return 'rgba(40, 167, 69, 0.6)';

        if (category === 'Income from investment at FV realised Gain') return 'rgba(40, 167, 69, 0.6)';

        // Investment income - Purple
        if ([
            'Unrealized Valuation from Investment at Fair Value',
            'Income from investment at FV realised Gain',
            'Dividend from investment at fair value P/L',
            'Dividend from Investment at cost',
            'Interest Income',
            'Income from investment at Octal',
            'Change in the fair value of equity investment at fair value through OCI',
            'Gain from disposal of associate',
            'Remeasurement of defined employee benefits obligations',
            'Total Investment Income'
        ].includes(category)) return 'rgba(111, 66, 193, 0.8)';

        // Final profit/loss - Conditional color
        if (category === 'Current Year Profit /Loss') {
            return chartData[categories.indexOf(category)] >= 0 ?
                'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)';
        }

        return '#004557'; // Default gray
    });

    // Create the chart
    profitLossStatementChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Amount (SAR)',
                data: chartData,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color.replace('0.8', '1').replace('0.6', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            let value = context.parsed.y;
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (value !== null) {
                                // Show absolute values in tooltips for better readability
                                const category = categories[context.dataIndex];
                                if (expenseCategories.includes(category)) {
                                    label += formatCurrency(Math.abs(value));
                                } else {
                                    label += formatCurrency(value);
                                }
                            }
                            return label;
                        }
                    }
                },
                title: {
                    display: true,
                    text: '',
                    font: {
                        size: 16
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (SAR)'
                    },
                    ticks: {
                        callback: function (value) {
                            return formatCurrency(value);
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        callback: function (value, index) {
                            // Shorten long labels for better display
                            const label = this.getLabelForValue(value);
                            if (label.length > 15) {
                                return label.substring(0, 15) + '...';
                            }
                            return label;
                        }
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });

    console.log('Profit/Loss Statement chart initialized successfully');
        } catch (error) {
        console.error('Error initializing profit/loss statement chart:', error);
    }
    }

    function formatCurrency(value) {
        const absValue = Math.abs(value);
        if (absValue >= 1000000) {
            return (value / 1000000).toFixed(2) + 'M';
        } else if (absValue >= 1000) {
            return (value / 1000).toFixed(2) + 'K';
        } else {
            return value.toFixed(2);
        }
    }

    // Refresh functions
    function refreshAssetData() {
        location.reload();
    }

    function refreshLiabilityData() {
        location.reload();
    }
</script>
{% endblock %}
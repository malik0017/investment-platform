<!-- backend/templates/admin_schedule_calendar.html -->
{% extends "admin_base.html" %}
{% block title %}Schedule Calendar - Dashboard{% endblock %}
{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>

    .fc-event {
    background: none !important;
    border: none !important;
    color: #333 !important;
    font-size: 0.85rem;
    padding: 4px 6px;
    border-radius: 6px;
    position: relative;
}

/* Event container */
.fc-event-main-frame {
    background: aliceblue;
    border: 1px solid #e1e1e1;
    border-left: 4px solid;
    border-radius: 8px;
    padding: 4px 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

/* Event type badges */
.event-type-badge {
    display: inline-block;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    margin-bottom: 2px;
}

/* Event type specific styles */
.fc-event.meeting .fc-event-main-frame { border-left-color: #0dcaf0; }
.fc-event.event .fc-event-main-frame { border-left-color: #198754; }
.fc-event.announcement .fc-event-main-frame { border-left-color: #dc3545; }

.fc-event.meeting .event-type-badge { background: #e0f7fa; color: #0dcaf0; }
.fc-event.event .event-type-badge { background: #e9fbe9; color: #198754; }
.fc-event.announcement .event-type-badge { background: #fdeaea; color: #dc3545; }





    /* .fc-event {
        cursor: pointer;
        border: none;
        font-size: 0.85rem;
    } */

    .modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    /* .event-type-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        font-size: 0.7rem;
        padding: 2px 5px;
        border-radius: 4px;
    } */

    .time-slot-btn {
        margin: 2px;
        padding: 5px 10px;
        transition: all 0.2s ease;
    }

    .time-slot-btn.active {
        background-color: #0d6efd;
        color: white;
        transform: scale(1.05);
    }

    .time-slot-btn:hover:not(.active) {
        background-color: #f8f9fa;
    }

    .calendar-sidebar {
        background-color: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        height: fit-content;
    }

    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 350px;
    }

    .custom-toast {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 16px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        animation: slideInRight 0.3s ease, fadeOut 0.5s ease 4.5s forwards;
    }

    .toast-success {
        border-left: 4px solid #28a745;
    }

    .toast-error {
        border-left: 4px solid #dc3545;
    }

    .toast-icon {
        font-size: 24px;
        margin-right: 12px;
    }

    .toast-success .toast-icon {
        color: #28a745;
    }

    .toast-error .toast-icon {
        color: #dc3545;
    }

    .toast-content {
        flex: 1;
    }

    .toast-title {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .toast-message {
        color: #6c757d;
        font-size: 14px;
    }

    .toast-close {
        background: none;
        border: none;
        font-size: 18px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        margin-left: 10px;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }

</style>
{% endblock %}
{% block content %}

<div class="container-fluid mt-4">
    <div class="row gx-3 align-items-center">
        <div class="col-12 col-sm">
            <nav aria-label="breadcrumb" class="mb-2">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Schedule</li>
                </ol>
            </nav>
            <h5>Schedule Calendar</h5>
        </div>
        <div class="col-auto py-1 ms-auto ms-sm-0">
            <button class="btn btn-theme" id="createEventBtn">
                <i data-feather="plus" class="me-0 me-md-1"></i>
                <span class="d-none d-md-inline-block">Create Event</span>
            </button>
        </div>
    </div>
</div>

<div class="container" id="main-content">
    <div class="row mt-4 mb-4">
        <div class="col-12 col-md-12 col-xl-12">
            <div class="card adminuiux-card mb-4">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Create New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="eventTitle" class="form-label">Title *</label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="eventType" class="form-label">Event Type *</label>
                            <select class="form-select" id="eventType" required>
                                <option value="meeting">Meeting</option>
                                <option value="event">Event</option>
                                <option value="announcement">Announcement</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDateTime" class="form-label">Start Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="startDateTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDateTime" class="form-label">End Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="endDateTime" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="eventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="eventAttendees" class="form-label">Attendees (comma separated emails)</label>
                        <input type="text" class="form-control" id="eventAttendees"
                            placeholder="email1@example.com, email2@example.com"
                            value="">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sendEmail">
                        <label class="form-check-label" for="sendEmail">
                            Send email notification to attendees
                        </label>
                    </div>
                    <div id="emailFields" style="display: none;">
                        <div class="mb-3">
                            <label for="emailSubject" class="form-label">Email Subject</label>
                            <input type="text" class="form-control" id="emailSubject"
                                placeholder="Enter Title">
                        </div>
                        <div class="mb-3">
                            <label for="emailMessage" class="form-label">Email Message</label>
                            <textarea class="form-control" id="emailMessage" rows="3"
                                placeholder=""></textarea>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="whatsappNumbers" class="form-label">WhatsApp Numbers (comma separated with country code)</label>
                        <input type="text" class="form-control" id="whatsappNumbers"
                            placeholder="+966532369912, +966559036130, +966590369375" value="">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sendWhatsapp">
                        <label class="form-check-label" for="sendWhatsapp">
                            Send WhatsApp notification
                        </label>
                    </div>
                </form>
                <div class="card mt-3">
                    <div class="card-header">
                        <h6>WhatsApp Setup Instructions - IMPORTANT</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-danger"><strong>Before receiving WhatsApp messages, each recipient must:</strong></p>
                        <ol>
                            <li>Open WhatsApp on their phone</li>
                            <li>Send the join code to <strong>whatsapp:+14155238886</strong></li>
                            <li>Wait for confirmation message from Twilio</li>
                            <li>They can now receive WhatsApp notifications</li>
                        </ol>
                        <div class="alert alert-info">
                            <strong>Join Code:</strong> Your sandbox join phrase is usually something like "join example-123"<br>
                            <strong>Find it in:</strong> Twilio Console → WhatsApp → Sandbox → Sandbox Configuration
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteEventBtn" style="display: none;">Delete</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Save Event</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Toast notification system
    function showToast(title, message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `custom-toast toast-${type}`;

        const icons = {
            success: '✓',
            error: '✗',
            warning: '⚠',
            info: 'ℹ'
        };

        toast.innerHTML = `
            <div class="toast-icon">${icons[type]}</div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;

        toastContainer.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Initialize date picker with Flatpickr
        const datepicker = flatpickr("#selectedDate", {
            dateFormat: "Y-m-d",
            defaultDate: "today",
        });

        let calendarEl = document.getElementById('calendar');
        let calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/admin/schedule_calendar/events',
            editable: true,
            selectable: true,
            eventClick: function (info) {
                // Load event data into modal
                $('#eventId').val(info.event.id);
                $('#eventTitle').val(info.event.title);
                $('#eventType').val(info.event.extendedProps.eventType);
                $('#startDateTime').val(info.event.start.toISOString().slice(0, 16));
                $('#endDateTime').val(info.event.end ? info.event.end.toISOString().slice(0, 16) : '');
                $('#eventLocation').val(info.event.extendedProps.location || '');
                $('#eventDescription').val(info.event.extendedProps.description || '');
                $('#eventAttendees').val(info.event.extendedProps.attendees ? info.event.extendedProps.attendees.join(', ') : '');

                // Show delete button
                $('#deleteEventBtn').show();

                // Show modal
                $('#eventModal').modal('show');
            },
            select: function (info) {
                openEventModal(info.start, info.end);
                calendar.unselect();
            },
            eventContent: function (arg) {
                // Custom event content
                let eventTypeBadge = '';
                if (arg.event.extendedProps.eventType) {
                    let badgeClass = 'bg-white';
                    if (arg.event.extendedProps.eventType === 'meeting') badgeClass = 'bg-info';
                    if (arg.event.extendedProps.eventType === 'announcement') badgeClass = 'bg-danger';
                    if (arg.event.extendedProps.eventType === 'event') badgeClass = 'bg-success';

                    eventTypeBadge = `<span class="badge ${badgeClass} event-type-badge">${arg.event.extendedProps.eventType}</span>`;
                }

                // Add event time
                const startTime = arg.event.start ? arg.event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                const endTime = arg.event.end ? arg.event.end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                const timeStr = startTime && endTime ? `<div class="fc-event-time">${startTime} - ${endTime}</div>` : '';

                return {
                    html: `
                     <div class="fc-event-main-frame">
                    ${eventTypeBadge}
                    <div class="fc-event-title-container">
                        <div class="fc-event-title">${arg.event.title}</div>
                        ${timeStr}
                    </div>
                </div>
                `
                };
            }
        });

        calendar.render();

        // Manual create event button
        $('#createEventBtn').click(function () {
            openEventModal();
        });

        // Toggle email fields
        $('#sendEmail').change(function () {
            if ($(this).is(':checked')) {
                $('#emailFields').slideDown();

                // Auto-populate email subject if empty
                if (!$('#emailSubject').val()) {
                    $('#emailSubject').val(' ' + $('#eventTitle').val());
                }

                // Auto-populate email message if empty
                if (!$('#emailMessage').val()) {
                    $('#emailMessage').val($('#eventTitle').val());
                }
            } else {
                $('#emailFields').slideUp();
            }
        });

        // Save event
        $('#saveEventBtn').click(function () {
            // Basic validation
            if (!$('#eventTitle').val()) {
                showToast('Error', 'Please enter an event title', 'error');
                return;
            }

            if (!$('#startDateTime').val() || !$('#endDateTime').val()) {
                showToast('Error', 'Please select start and end times', 'error');
                return;
            }

            const eventData = {
                title: $('#eventTitle').val(),
                eventType: $('#eventType').val(),
                start: $('#startDateTime').val(),
                end: $('#endDateTime').val(),
                location: $('#eventLocation').val(),
                description: $('#eventDescription').val(),
                attendees: $('#eventAttendees').val().split(',').map(email => email.trim()).filter(email => email),
                sendEmail: $('#sendEmail').is(':checked'),
                emailSubject: $('#emailSubject').val(),
                emailMessage: $('#emailMessage').val(),
                sendWhatsapp: $('#sendWhatsapp').is(':checked'),
                whatsappNumbers: $('#whatsappNumbers').val().split(',').map(num => num.trim()).filter(num => num)
            };

            // Show loading state
            const saveBtn = $(this);
            const originalText = saveBtn.html();
            saveBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            saveBtn.prop('disabled', true);

            const eventId = $('#eventId').val();
            const url = eventId ? `/admin/schedule_calendar/update_event/${eventId}` : '/admin/schedule_calendar/create_event';
            const method = eventId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
                .then(response => {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json();
                    } else {
                        return response.text().then(text => {
                            throw new Error(`Expected JSON but got: ${text.substring(0, 100)}...`);
                        });
                    }
                })
                .then(data => {
                    if (data.success) {
                        $('#eventModal').modal('hide');
                        calendar.refetchEvents();
                        showToast('Success', data.message || 'Event saved successfully!', 'success');
                    } else {
                        showToast('Error', data.message || 'Failed to save event', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error details:', error);
                    showToast('Error', error.message || 'An unexpected error occurred', 'error');
                })
                .finally(() => {
                    // Restore button state
                    saveBtn.html(originalText);
                    saveBtn.prop('disabled', false);
                });
        });

        // Delete event
        $('#deleteEventBtn').click(function () {
            if (confirm('Are you sure you want to delete this event?')) {
                const eventId = $('#eventId').val();

                fetch(`/admin/schedule_calendar/delete_event/${eventId}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            $('#eventModal').modal('hide');
                            calendar.refetchEvents();
                            showToast('Success', 'Event deleted successfully!', 'success');
                        } else {
                            showToast('Error', data.message || 'Failed to delete event', 'error');
                        }
                    })
                    .catch(error => {
                        showToast('Error', error.message || 'An unexpected error occurred', 'error');
                    });
            }
        });

        // Helper functions
        function openEventModal(start, end) {
            // Clear form for new event
            $('#eventForm')[0].reset();
            $('#eventId').val('');
            $('#deleteEventBtn').hide();
            $('#emailFields').hide();

            // Set start and end times if provided
            if (start) {
                $('#startDateTime').val(start.toISOString().slice(0, 16));
            }
            if (end) {
                $('#endDateTime').val(end.toISOString().slice(0, 16));
            }

            // Show modal
            $('#eventModal').modal('show');
        }

        function add30Minutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            let newHours = hours;
            let newMinutes = minutes + 30;

            if (newMinutes >= 60) {
                newHours += 1;
                newMinutes -= 60;
            }

            return `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
        }
    });


</script>
{% endblock %}